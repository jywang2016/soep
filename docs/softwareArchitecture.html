

<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>5. Software Architecture &#8212; Spawn of EnergyPlus</title>
    <link rel="stylesheet" href="_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/basic.css" />
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="_static/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="_static/bootstrap_custom.css" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="_static/custom-sphinx.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="_static/bootstrap-sphinx.js"></script>
    <link rel="shortcut icon" href="_static/lbl-icon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="6. Numerical Methods of the Master Algorithm" href="numericalMethods.html" />
    <link rel="prev" title="4. Requirements" href="requirements.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head><body>

  <div id="navbar" class="navbar navbar-default ">
    <div class="container-fluid">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html"><img src="_static/soep-logo.png">
           </a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="index.html">Index</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="preample.html">1. Preample</a><ul>
<li class="toctree-l2"><a class="reference internal" href="preample.html#purpose-of-the-document">1.1. Purpose of the Document</a></li>
<li class="toctree-l2"><a class="reference internal" href="preample.html#contributors">1.2. Contributors</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="conventions.html">2. Conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="useCases.html">3. Use Cases</a><ul>
<li class="toctree-l2"><a class="reference internal" href="useCases.html#openstudio-integration">3.1. OpenStudio Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="useCases.html#measures">3.2. Measures</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="requirements.html">4. Requirements</a><ul>
<li class="toctree-l2"><a class="reference internal" href="requirements.html#openstudio-integration">4.1. OpenStudio integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="requirements.html#mathematics">4.2. Mathematics</a></li>
<li class="toctree-l2"><a class="reference internal" href="requirements.html#fmu-requirements">4.3. FMU Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="requirements.html#qss-implementation">4.4. QSS Implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="requirements.html#master-algorithm">4.5. Master Algorithm</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">5. Software Architecture</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overall-software-architecture">5.1. Overall software architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="#coupling-of-energyplus-envelope-and-room-with-modelica-based-hvac-and-control">5.2. Coupling of EnergyPlus envelope and room with Modelica-based HVAC and control</a></li>
<li class="toctree-l2"><a class="reference internal" href="#jmodelica-integration">5.3. JModelica Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#openstudio-integration">5.4. OpenStudio integration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="numericalMethods.html">6. Numerical Methods of the Master Algorithm</a><ul>
<li class="toctree-l2"><a class="reference internal" href="numericalMethods.html#time-integration">6.1. Time Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="numericalMethods.html#algebraic-loops">6.2. Algebraic Loops</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api.html">7. Application Programming Interface</a><ul>
<li class="toctree-l2"><a class="reference internal" href="api.html#generating-openstudio-models">7.1. Generating OpenStudio Models</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="benchmarks.html">8. Benchmarks</a></li>
<li class="toctree-l1"><a class="reference internal" href="acknowledgments.html">9. Acknowledgments</a></li>
<li class="toctree-l1"><a class="reference internal" href="zreferences.html">10. References</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">5. Software Architecture</a><ul>
<li><a class="reference internal" href="#overall-software-architecture">5.1. Overall software architecture</a></li>
<li><a class="reference internal" href="#coupling-of-energyplus-envelope-and-room-with-modelica-based-hvac-and-control">5.2. Coupling of EnergyPlus envelope and room with Modelica-based HVAC and control</a><ul>
<li><a class="reference internal" href="#assumptions-and-limitations">5.2.1. Assumptions and limitations</a></li>
<li><a class="reference internal" href="#partitioning-of-the-models">5.2.2. Partitioning of the models</a></li>
<li><a class="reference internal" href="#data-exchange">5.2.3. Data exchange</a></li>
<li><a class="reference internal" href="#time-synchronization">5.2.4. Time synchronization</a></li>
<li><a class="reference internal" href="#requirements-for-exporting-energyplus-as-an-fmu-for-model-exchange">5.2.5. Requirements for Exporting EnergyPlus as an FMU for model exchange</a><ul>
<li><a class="reference internal" href="#instantiation">5.2.5.1. Instantiation</a></li>
<li><a class="reference internal" href="#configuring-variables-to-be-exchanged">5.2.5.2. Configuring variables to be exchanged</a></li>
<li><a class="reference internal" href="#setting-up-the-experiment-time">5.2.5.3. Setting up the experiment time</a></li>
<li><a class="reference internal" href="#setting-the-current-time">5.2.5.4. Setting the current time</a></li>
<li><a class="reference internal" href="#sending-parameters-and-variables-to-energyplus">5.2.5.5. Sending parameters and variables to EnergyPlus</a></li>
<li><a class="reference internal" href="#retrieving-parameters-and-variables-from-energyplus">5.2.5.6. Retrieving parameters and variables from EnergyPlus</a></li>
<li><a class="reference internal" href="#retrieving-the-next-event-time">5.2.5.7. Retrieving the next event time</a></li>
<li><a class="reference internal" href="#terminating-the-energyplus-simulation">5.2.5.8. Terminating the EnergyPlus simulation</a></li>
<li><a class="reference internal" href="#writing-energyplus-output-files">5.2.5.9. Writing EnergyPlus output files</a></li>
</ul>
</li>
<li><a class="reference internal" href="#pseudo-code-example">5.2.6. Pseudo Code Example</a></li>
<li><a class="reference internal" href="#tool-for-exporting-energyplus-as-an-fmu">5.2.7. Tool for Exporting EnergyPlus as an FMU</a></li>
</ul>
</li>
<li><a class="reference internal" href="#jmodelica-integration">5.3. JModelica Integration</a><ul>
<li><a class="reference internal" href="#fmi-changes-for-qss">5.3.1. FMI Changes for QSS</a><ul>
<li><a class="reference internal" href="#event-handling">5.3.1.1. Event Handling</a><ul>
<li><a class="reference internal" href="#state-events">5.3.1.1.1. State Events</a></li>
<li><a class="reference internal" href="#event-indicators-that-depend-on-the-input">5.3.1.1.2. Event indicators that depend on the input</a></li>
<li><a class="reference internal" href="#handling-of-variables-reinitialized-with-reinit">5.3.1.1.3. Handling of variables reinitialized with <code class="docutils literal notranslate"><span class="pre">reinit()</span></code></a></li>
<li><a class="reference internal" href="#workaround-for-implementing-event-indicators">5.3.1.1.4. Workaround for implementing event indicators</a></li>
<li><a class="reference internal" href="#time-events">5.3.1.1.5. Time Events</a></li>
</ul>
</li>
<li><a class="reference internal" href="#smoothtoken-for-qss">5.3.1.2. SmoothToken for QSS</a></li>
<li><a class="reference internal" href="#summary-of-proposed-changes">5.3.1.3. Summary of Proposed Changes</a></li>
<li><a class="reference internal" href="#open-topics">5.3.1.4. Open Topics</a><ul>
<li><a class="reference internal" href="#atomic-api">5.3.1.4.1. Atomic API</a></li>
<li><a class="reference internal" href="#xml-api">5.3.1.4.2. XML/API</a></li>
<li><a class="reference internal" href="#higher-derivatives">5.3.1.4.3. Higher Derivatives</a></li>
<li><a class="reference internal" href="#input-variables">5.3.1.4.4. Input Variables</a></li>
<li><a class="reference internal" href="#annotations">5.3.1.4.5. Annotations</a></li>
<li><a class="reference internal" href="#conditional-expressions-and-event-indicators">5.3.1.4.6. Conditional Expressions and Event Indicators</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#openstudio-integration">5.4. OpenStudio integration</a><ul>
<li><a class="reference internal" href="#automated-documentation-ast-support-tool">5.4.1. Automated Documentation/AST Support Tool</a><ul>
<li><a class="reference internal" href="#background">5.4.1.1. Background</a></li>
<li><a class="reference internal" href="#requirements">5.4.1.2. Requirements</a></li>
<li><a class="reference internal" href="#literature-review">5.4.1.3. Literature review</a></li>
<li><a class="reference internal" href="#implementation">5.4.1.4. Implementation</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="requirements.html" title="Previous Chapter: 4. Requirements"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; 4. Requirements</span>
    </a>
  </li>
  <li>
    <a href="numericalMethods.html" title="Next Chapter: 6. Numerical Methods of the Master Algorithm"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">6. Numerical ... &raquo;</span>
    </a>
  </li>
              
            
            
            
            
          </ul>

<!--
          
            
<form class="navbar-form navbar-right" action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
-->
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <div class="section" id="software-architecture">
<span id="sec-soft-arch"></span><h1>5. Software Architecture<a class="headerlink" href="#software-architecture" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overall-software-architecture">
<h2>5.1. Overall software architecture<a class="headerlink" href="#overall-software-architecture" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="#fig-overall-software-architecture"><span class="std std-numref">Fig. 5.1</span></a>
shows the overall software architecture of SOEP.</p>
<p>The <cite>Application</cite> on top of the figure may be an
equipment sales tool that uses an open, or a proprietary,
Modelica model library of their product line, which allows
a sales person to test and size equipment for a particular customer.</p>
<p>The <cite>HVAC Systems Editor</cite> allows drag and drop of components,
which are read dynamically from the <cite>Modelica Library AST</cite>,
similar to what can be done in today’s OS schematic editor.
In contrast, the <cite>Schematic Editor</cite> allows to freely place
and graphically connect Modelica components.
Once models have been manipulated in the
<cite>Schematic Editor</cite>, OS can only simulate them, but not apply
OS Measures to it, as models may have become incompatible
with the OS Measures. (This could in the future be changed
by parsing the AST of the model.)</p>
<p>In the <cite>Schematic Editor</cite>, user-provided Modelica libraries
can be loaded (for example, if a company has their own
control sequence library), manipulated and stored again
in the user-provided Modelica library. This functionality is also
needed for the OpenBuildingControl project.</p>
<p>Currently, the OpenStudio Model Library is compiled C++ code.
Our integration will generate a representation of the
Modelica library that allows OpenStudio to
dynamic load models for the SOEP mode.
Note that the JModelica distribution includes a C++ compiler.</p>
<div class="figure" id="id12">
<span id="fig-overall-software-architecture"></span><p class="plantuml">
<object data="_images/plantuml-42b14e268a4f127550932a42892ae7433788991a.svg" type="image/svg+xml" style="width:1011px;height:778px;">
<img src="_images/plantuml-42b14e268a4f127550932a42892ae7433788991a.png" alt="title Overall software architecture

scale max 1024 width

skinparam componentStyle uml2

package OpenStudio {
interface API
API - [Core]

package Legacy-Mode {
database &quot;Legacy\nModel Library&quot;
[Core] -&gt; [Legacy\nModel Library]: integrates
[Core] -&gt; [HVAC Systems Editor\n(Legacy Mode)]: integrates
[Core] -&gt; [EnergyPlus\nSimulator Interface]: integrates
}

package SOEP-Mode {

[Core] --&gt; [Model Library]: integrates
[Core] --&gt; [HVAC Systems Editor\n(SOEP Mode)]: integrates
[Core] --&gt; [SOEP\nSimulator Interface]: integrates
}
}

package SOEP {
database &quot;Modelica\nLibrary AST&quot; as mod_AST
database &quot;Modelica\nBuildings Library&quot;

[Model Library] --&gt; mod_AST : parses json\nAST

[HVAC Systems Editor\n(SOEP Mode)] ..&gt; mod_AST : parses json\nAST

[Conversion Script] .&gt; [JModelica]: parses\nAST
[SOEP\nSimulator Interface] .&gt; [JModelica] : writes inputs,\nruns simulation,\nreads outputs

[Conversion Script] -&gt; mod_AST: generates
[JModelica] -&gt; [Modelica\nBuildings Library]: imports
}


actor Developer as epdev
[Legacy\nModel Library] &lt;.. epdev : updates

actor &quot;Developer or User&quot; as modev
[Conversion Script] &lt;.. modev : invokes

actor Developer as budev
[Modelica\nBuildings Library] &lt;.. budev : adds annotations

actor User as mouse
[User-Provided\nModelica Library] &lt;.. mouse : adds annotations


[Application] ..&gt; () API : uses
[Measures] ..&gt; () API : uses

database &quot;User-Provided\nModelica Library&quot;
[JModelica] --&gt; [User-Provided\nModelica Library]: imports

EnergyPlus &lt;.. [EnergyPlus\nSimulator Interface]: writes inputs,\nruns simulation,\nreads outputs

package EnergyPlus {
  [EnergyPlus.exe]
}

note left of mod_AST
  Used as an intermediate format and
  to verify incompatible changes.
end note

note bottom of [User-Provided\nModelica Library]
  Allows companies to use
  their own Modelica libraries
  with custom HVAC systems and
  control sequences, or
  to integrate an electronic
  equipment catalog or a
  library used for an equipment
  sales tool.
end note

note right of Application
  Application that uses
  the OpenStudio SDK.
end note"/>

</object></p>
<p class="caption"><span class="caption-number">Fig. 5.1 </span>: Overall software architecture.<a class="headerlink" href="#id12" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="coupling-of-energyplus-envelope-and-room-with-modelica-based-hvac-and-control">
<h2>5.2. Coupling of EnergyPlus envelope and room with Modelica-based HVAC and control<a class="headerlink" href="#coupling-of-energyplus-envelope-and-room-with-modelica-based-hvac-and-control" title="Permalink to this headline">¶</a></h2>
<p>This section describes the refactoring of the
EnergyPlus room model, which will remain in the C/C++ implementation
of EnergyPlus, to a form that exposes the time derivative of its room model.
EnergyPlus will be exported as an FMU for model exchange.</p>
<p>The time integration of the room air temperature, moisture and
trace substance concentrations will be done by the master algorithm.</p>
<p>EnergyPlus will synchronize the room model and the envelope model.</p>
<p>We will use the following terminology: By <cite>envelope model</cite>, we mean
the model for the heat and moisture transfer through opaque constructions
and through windows.
By <cite>room model</cite>, we mean the room air heat, mass and trace substance balance.
By <cite>HVAC model</cite>, we mean the HVAC and control model.</p>
<p>The physical quantities that need to be exchanged are as follows.
For a convective HVAC system, the convective and latent heat gain added
by the HVAC system,
the mass flow rates of trace substances such as CO2 and VoC, and
the state of the return air, e.g., temperature, relative humidity and pressure.
For radiant systems, the temperature of the radiant surface,
and the heat flow rates due to conduction, short-wave and long-wave radiation.</p>
<div class="section" id="assumptions-and-limitations">
<h3>5.2.1. Assumptions and limitations<a class="headerlink" href="#assumptions-and-limitations" title="Permalink to this headline">¶</a></h3>
<p>For the current implementation, we will make the following assumption:</p>
<ol class="arabic">
<li><p class="first">Only the lumped room air model will be refactored, not the
room model with stratified room air.
The reason is to keep focus and make progress before increasing complexity.</p>
</li>
<li><p class="first">The HVAC and the pressure driven air exchange (airflow network) are
either in legacy EnergyPlus or in FMUs of the SOEP.
The two methods cannot be combined.
The reason is that the legacy EnergyPlus computes in its “predictor/corrector”
the room temperature as follows:</p>
<ol class="loweralpha simple">
<li>It computes the HVAC power required to meet the temperature set point.</li>
<li>It simulates the HVAC system to see whether it can meet this load.</li>
<li>It updates the room temperature using the HVAC power from step (b).</li>
</ol>
<p>This is fundamentally different from the ODE solver used by SOEP who sets the new
room temperature and time, requests its time derivative, and then recomputes
the new time step.</p>
</li>
<li><p class="first">In each room, mass, as opposed to volume, is conserved.
The reason is that this does not induce an air flow in the HVAC system if
the room temperature changes. Hence, it decouples the thermal and the mass balance.</p>
</li>
</ol>
</div>
<div class="section" id="partitioning-of-the-models">
<h3>5.2.2. Partitioning of the models<a class="headerlink" href="#partitioning-of-the-models" title="Permalink to this headline">¶</a></h3>
<p>To link the envelope model, the room model and the HVAC model, we partition the simulation
as shown in <a class="pageref" href="#fig-partition-envelop-room-hvac">Figure  2</a>.</p>
<div class="figure" id="id13">
<span id="fig-partition-envelop-room-hvac"></span><a class="reference internal image-reference" href="_images/envelop-room-hvac.svg"><img alt="_images/envelop-room-hvac.svg" src="_images/envelop-room-hvac.svg" /></a>
<p class="caption"><span class="caption-number">Fig. 5.2 </span>: Partitioning of the envelope, room and HVAC model.</span></p>
</div>
<p>The EnergyPlus FMU is for model exchange and contains the
envelope and the room surfaces.
All of the HVAC system and other pressure driven mass flow
rates, such as infiltration due to wind pressure or static
pressure differences, are computed in the HVAC FMUs.
There can be one or several HVAC FMUs, which is irrelevant
as EnergyPlus will only see one set of variables that it
exchanges with the master algorithm.</p>
</div>
<div class="section" id="data-exchange">
<span id="sec-data-exchange"></span><h3>5.2.3. Data exchange<a class="headerlink" href="#data-exchange" title="Permalink to this headline">¶</a></h3>
<p>The following parameters are sent from EnergyPlus to Modelica. These are sent only once during the initialization for each thermal zone.</p>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="16%" />
<col width="60%" />
<col width="9%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Variable</th>
<th class="head">Dimension</th>
<th class="head">Quantity</th>
<th class="head">Unit</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td colspan="4"><em>From EnergyPlus to Modelica</em></td>
</tr>
<tr class="row-odd"><td>V</td>
<td><span class="math notranslate nohighlight">\(1\)</span></td>
<td>Volume of the zone air</td>
<td>m3</td>
</tr>
<tr class="row-even"><td>AFlo</td>
<td><span class="math notranslate nohighlight">\(1\)</span></td>
<td>Floor area of the zone</td>
<td>m2</td>
</tr>
<tr class="row-odd"><td>mSenFac</td>
<td><span class="math notranslate nohighlight">\(1\)</span></td>
<td>Factor for scaling the sensible thermal mass of the zone air volume</td>
<td>1</td>
</tr>
</tbody>
</table>
<p>The following time-dependent variables are exchanged between EnergyPlus and Modelica during the time integration
for each thermal zone.</p>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="16%" />
<col width="60%" />
<col width="9%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Variable</th>
<th class="head">Dimension</th>
<th class="head">Quantity</th>
<th class="head">Unit</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td colspan="4"><em>From Modelica to EnergyPlus</em></td>
</tr>
<tr class="row-odd"><td>T</td>
<td><span class="math notranslate nohighlight">\(1\)</span></td>
<td>Temperature of the zone air</td>
<td>degC</td>
</tr>
<tr class="row-even"><td>X</td>
<td><span class="math notranslate nohighlight">\(1\)</span></td>
<td>Water vapor mass fraction per total air mass of the zone</td>
<td>kg/kg</td>
</tr>
<tr class="row-odd"><td>mInlets_flow</td>
<td><span class="math notranslate nohighlight">\(1\)</span></td>
<td>Sum of positive mass flow rates into the zone for all air inlets (including infiltration)</td>
<td>kg/s</td>
</tr>
<tr class="row-even"><td>TInlet</td>
<td><span class="math notranslate nohighlight">\(1\)</span></td>
<td>Average of inlets medium temperatures carried by the mass flow rates</td>
<td>degC</td>
</tr>
<tr class="row-odd"><td>QGaiRad_flow</td>
<td><span class="math notranslate nohighlight">\(1\)</span></td>
<td>Radiative sensible heat gain added to the zone</td>
<td>W</td>
</tr>
<tr class="row-even"><td>t</td>
<td><span class="math notranslate nohighlight">\(1\)</span></td>
<td>Model time at which the above inputs are valid, with <span class="math notranslate nohighlight">\(t=0\)</span> defined as January 1, 0 am local time,
and with
no correction for daylight savings time</td>
<td>s</td>
</tr>
<tr class="row-odd"><td colspan="4"><em>From EnergyPlus to Modelica</em></td>
</tr>
<tr class="row-even"><td>TRad</td>
<td><span class="math notranslate nohighlight">\(1\)</span></td>
<td>Average radiative temperature in the room</td>
<td>degC</td>
</tr>
<tr class="row-odd"><td>QConSen_flow</td>
<td><span class="math notranslate nohighlight">\(1\)</span></td>
<td>Convective sensible heat added to the zone, e.g., as entered in
the EnergyPlus’ <code class="docutils literal notranslate"><span class="pre">People</span></code> or <code class="docutils literal notranslate"><span class="pre">Equipment</span></code> schedule</td>
<td>W</td>
</tr>
<tr class="row-even"><td>QLat_flow</td>
<td><span class="math notranslate nohighlight">\(1\)</span></td>
<td>Latent heat gain added to the zone, e.g., from mass transfer with moisture buffering material and
from EnergyPlus’ <code class="docutils literal notranslate"><span class="pre">People</span></code> schedule</td>
<td>W</td>
</tr>
<tr class="row-odd"><td>QPeo_flow</td>
<td><span class="math notranslate nohighlight">\(1\)</span></td>
<td>Heat gain due to people (only to be used to optionally compute CO2 emitted by people)</td>
<td>W</td>
</tr>
<tr class="row-even"><td>nextEventTime</td>
<td><span class="math notranslate nohighlight">\(1\)</span></td>
<td>Model time <span class="math notranslate nohighlight">\(t\)</span> when EnergyPlus needs to be called next (typically the next zone time step)</td>
<td>s</td>
</tr>
</tbody>
</table>
<p>Note that the EnergyPlus object <code class="docutils literal notranslate"><span class="pre">ZoneAirContaminantBalance</span></code> either allows CO2 concentration modeling,
or a generic contaminant modeling (such as from material outgasing),
or no contaminant modeling, or both. To allow ambiguities regarding what contaminant
is being modeled, we do not receive the contaminant emission from EnergyPlus.
Instead, we obtain the heat gain due to people, which is then used to optionally computed the
CO2 emitted by people.</p>
<p>For this coupling, all zones of EnergyPlus will be accessed from Modelica.
For example, if a building has two zones, then both zones need to be modeled in Modelica.</p>
</div>
<div class="section" id="time-synchronization">
<span id="sec-time-sync"></span><h3>5.2.4. Time synchronization<a class="headerlink" href="#time-synchronization" title="Permalink to this headline">¶</a></h3>
<p>As shown in <a class="pageref" href="#fig-partition-envelop-room-hvac">Figure  2</a>, the EnergyPlus FMU is invoked
at a variable time step.
Internally, it samples its heat conduction model at the envelope time step <span class="math notranslate nohighlight">\(\Delta t_z\)</span>.
EnergyPlus needs to report this to the FMI interface. To report such time events,
the FMI interface uses a C structure called <code class="docutils literal notranslate"><span class="pre">fmi2EventInfo</span></code> which is implemented as follows:</p>
<div class="code c highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">typedef</span> <span class="n">struct</span><span class="p">{</span>
  <span class="n">fmi2Boolean</span> <span class="n">newDiscreteStatesNeeded</span><span class="p">;</span>
  <span class="n">fmi2Boolean</span> <span class="n">terminateSimulation</span><span class="p">;</span>
  <span class="n">fmi2Boolean</span> <span class="n">nominalsOfContinuousStatesChanged</span><span class="p">;</span>
  <span class="n">fmi2Boolean</span> <span class="n">valuesOfContinuousStatesChanged</span><span class="p">;</span>
  <span class="n">fmi2Boolean</span> <span class="n">nextEventTimeDefined</span><span class="p">;</span>
  <span class="n">fmi2Real</span>
  <span class="n">nextEventTime</span><span class="p">;</span> <span class="o">//</span> <span class="nb">next</span> <span class="n">event</span> <span class="k">if</span> <span class="n">nextEventTimeDefined</span><span class="o">=</span><span class="n">fmi2True</span>
  <span class="p">}</span> <span class="n">fmi2EventInfo</span><span class="p">;</span>
</pre></div>
</div>
<p>The variable <code class="docutils literal notranslate"><span class="pre">nextEventTime</span></code> needs to be set to the time when the next event happens
in EnergyPlus. This is, for example, whenever the envelope model advances time,
or when a schedule changes its value and this change affects the variables
that are sent from the EnergyPlus FMU to the master algorithm.
Such a schedule could for example be a time schedule for internal heat gains,
which may change at times that do not coincide with the zone time step <span class="math notranslate nohighlight">\(\Delta t_z\)</span>.</p>
</div>
<div class="section" id="requirements-for-exporting-energyplus-as-an-fmu-for-model-exchange">
<h3>5.2.5. Requirements for Exporting EnergyPlus as an FMU for model exchange<a class="headerlink" href="#requirements-for-exporting-energyplus-as-an-fmu-for-model-exchange" title="Permalink to this headline">¶</a></h3>
<p>To export EnergyPlus as an FMU for model exchange, EnergyPlus must be compiled as a shared library.
The shared library must export the functions which are described in the next section.
These functions are then used by the FMI for model exchange wrapper that LBL is developing.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In the current implementation, we assume that EnergyPlus does not support roll back in time.
This will otherwise require EnergyPlus to be able to save and restore its complete internal state.
This internal state consists especially of the values of the continuous-time states,
iteration variables, parameter values, input values, delay buffers, file identifiers and internal status information.
This limitation is indicated in the model description file with the capability flag <code class="docutils literal notranslate"><span class="pre">canGetAndSetFMUstate</span></code>
being set to <code class="docutils literal notranslate"><span class="pre">false</span></code>. If this capability were supported, then EnergyPlus could be used
with ODE solvers which can reject and repeat steps. Rejecting steps is needed by ODE solvers
such as DASSL or even Euler with step size control (but not for QSS)
as they may reject a step size if the error is too large.
Also, rejecting steps is needed to identify state events (but not for QSS solvers).</p>
</div>
<p>In the remainder of this section, we note that <code class="docutils literal notranslate"><span class="pre">time</span></code> is</p>
<blockquote>
<div><ul class="simple">
<li>the variable described as <code class="docutils literal notranslate"><span class="pre">t</span></code> in the table of section <a class="reference internal" href="#sec-data-exchange"><span class="std std-numref">Section 5.2.3</span></a>,</li>
<li>a monotonically increasing variable.</li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Monotonically increasing means that if a function has as argument <code class="docutils literal notranslate"><span class="pre">time</span></code> and is called at time <code class="docutils literal notranslate"><span class="pre">t1</span></code>, then its next call must happen at time <code class="docutils literal notranslate"><span class="pre">t2</span></code> with <code class="docutils literal notranslate"><span class="pre">t2</span></code> &gt;= <code class="docutils literal notranslate"><span class="pre">t1</span></code>.
For efficiency reasons, if a function which updates internal variables is called at the same time instant multiple times,
then only the first call will update the variables, subsequent calls will cause the functions to return the same variable values.</p>
</div>
<div class="section" id="instantiation">
<h4>5.2.5.1. Instantiation<a class="headerlink" href="#instantiation" title="Permalink to this headline">¶</a></h4>
<div class="code c highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">unsigned</span> <span class="nb">int</span> <span class="n">instantiate</span><span class="p">(</span><span class="n">const</span> <span class="n">char</span> <span class="n">const</span> <span class="o">*</span><span class="nb">input</span><span class="p">,</span>
                         <span class="n">const</span> <span class="n">char</span> <span class="n">const</span> <span class="o">*</span><span class="n">weather</span><span class="p">,</span>
                         <span class="n">const</span> <span class="n">char</span> <span class="n">const</span> <span class="o">*</span><span class="n">idd</span><span class="p">,</span>
                         <span class="n">const</span> <span class="n">char</span> <span class="n">const</span> <span class="o">*</span><span class="n">instanceName</span><span class="p">,</span>
                         <span class="n">const</span> <span class="n">char</span> <span class="o">**</span> <span class="n">parameterNames</span><span class="p">,</span>
                         <span class="n">const</span> <span class="n">unsigned</span> <span class="nb">int</span> <span class="n">parameterValueReferences</span><span class="p">[],</span>
                         <span class="n">size_t</span> <span class="n">nPar</span><span class="p">,</span>
                         <span class="n">const</span> <span class="n">char</span> <span class="o">**</span> <span class="n">inputNames</span><span class="p">,</span>
                         <span class="n">const</span> <span class="n">unsigned</span> <span class="nb">int</span> <span class="n">inputValueReferences</span><span class="p">[],</span>
                         <span class="n">size_t</span> <span class="n">nInp</span><span class="p">,</span>
                         <span class="n">const</span> <span class="n">char</span> <span class="o">**</span> <span class="n">outputNames</span><span class="p">,</span>
                         <span class="n">const</span> <span class="n">unsigned</span> <span class="nb">int</span> <span class="n">outputValueReferences</span><span class="p">[],</span>
                         <span class="n">size_t</span> <span class="n">nOut</span><span class="p">,</span>
                         <span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">log</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">input</span></code>: Absolute or relative path to an EnergyPlus input file with file name.</li>
<li><code class="docutils literal notranslate"><span class="pre">weather</span></code>: Absolute or relative path to an EnergyPlus weather file with file name.</li>
<li><code class="docutils literal notranslate"><span class="pre">idd</span></code>: Absolute or relative path to an EnergyPlus idd file with file name.</li>
<li><code class="docutils literal notranslate"><span class="pre">instanceName</span></code>: String to uniquely identify an EnergyPlus instance. This string must be non-empty and will be used for logging message.</li>
<li><code class="docutils literal notranslate"><span class="pre">parameterNames</span></code>: A vector of <code class="docutils literal notranslate"><span class="pre">nPar</span></code> strings that identifies the names of the parameters that are to be retrieved from EnergyPlus.</li>
<li><code class="docutils literal notranslate"><span class="pre">parameterValueReferences</span></code>: A vector of value references for the quantities in <code class="docutils literal notranslate"><span class="pre">parameterNames</span></code>.
Value references uniquely identify the variables, and are used in the <code class="docutils literal notranslate"><span class="pre">setVariables</span></code>
and <code class="docutils literal notranslate"><span class="pre">getVariables</span></code> calls below.</li>
<li><code class="docutils literal notranslate"><span class="pre">nPar</span></code>: Number of elements of the parameter vector, e.g.,
length of <code class="docutils literal notranslate"><span class="pre">parameterNames</span></code> and <code class="docutils literal notranslate"><span class="pre">parameterValueReferences</span></code>.</li>
<li><code class="docutils literal notranslate"><span class="pre">inputNames</span></code>: A vector of <code class="docutils literal notranslate"><span class="pre">nInp</span></code> strings that identifies the names of the inputs sent to EnergyPlus.</li>
<li><code class="docutils literal notranslate"><span class="pre">inputValueReferences</span></code>: A vector of value references for the quantities in <code class="docutils literal notranslate"><span class="pre">inputNames</span></code>.</li>
<li><code class="docutils literal notranslate"><span class="pre">nInp</span></code>: Number of elements of the input vector, e.g.,
length of <code class="docutils literal notranslate"><span class="pre">inputNames</span></code> and <code class="docutils literal notranslate"><span class="pre">inputValueReferences</span></code>.</li>
<li><code class="docutils literal notranslate"><span class="pre">outputNames</span></code>: A vector of <code class="docutils literal notranslate"><span class="pre">nOut</span></code> strings that identifies the names of the outputs to be
retrieved from EnergyPlus.</li>
<li><code class="docutils literal notranslate"><span class="pre">outputValueReferences</span></code>: A vector of value references for the quantities in <code class="docutils literal notranslate"><span class="pre">outputNames</span></code>.</li>
<li><code class="docutils literal notranslate"><span class="pre">nOut</span></code>: Number of elements of the output vector, e.g.,
length of <code class="docutils literal notranslate"><span class="pre">outputNames</span></code> and <code class="docutils literal notranslate"><span class="pre">outputValueReferences</span></code>.</li>
<li><code class="docutils literal notranslate"><span class="pre">log</span></code>: Logging message returned on error.</li>
</ul>
<p>For example, if a building has two zones called <code class="docutils literal notranslate"><span class="pre">basement</span></code> and <code class="docutils literal notranslate"><span class="pre">office</span></code>, then the parameter names are</p>
</div>
<div class="section" id="configuring-variables-to-be-exchanged">
<h4>5.2.5.2. Configuring variables to be exchanged<a class="headerlink" href="#configuring-variables-to-be-exchanged" title="Permalink to this headline">¶</a></h4>
<p>To configure the variables to be exchanged, the following data structures will be used.</p>
<div class="code c highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">char</span> <span class="o">**</span> <span class="n">parameterNames</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;basement,V&quot;</span><span class="p">,</span> <span class="s2">&quot;basement,AFlo&quot;</span><span class="p">,</span> <span class="s2">&quot;basement,mSenFac&quot;</span><span class="p">,</span> <span class="s2">&quot;office,V&quot;</span><span class="p">,</span> <span class="s2">&quot;office,AFlo&quot;</span><span class="p">,</span> <span class="s2">&quot;office,mSenFac&quot;</span><span class="p">};</span>
<span class="n">const</span> <span class="n">unsigned</span> <span class="nb">int</span> <span class="n">parameterValueReferences</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">};</span>
</pre></div>
</div>
<p>The inputs into EnergyPlus will be</p>
<div class="code c highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">char</span> <span class="o">**</span> <span class="n">inputNames</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;basement,T&quot;</span><span class="p">,</span> <span class="s2">&quot;basement,X&quot;</span><span class="p">,</span> <span class="s2">&quot;basement,mInlets_flow&quot;</span><span class="p">,</span> <span class="s2">&quot;basement,TInlet&quot;</span><span class="p">,</span> <span class="s2">&quot;basement,QGaiRad_flow&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;office,T&quot;</span><span class="p">,</span> <span class="s2">&quot;office,X&quot;</span><span class="p">,</span> <span class="s2">&quot;office,mInlets_flow&quot;</span><span class="p">,</span> <span class="s2">&quot;office,TInlet&quot;</span><span class="p">,</span> <span class="s2">&quot;office,QGaiRad_flow&quot;</span><span class="p">};</span>
<span class="n">const</span> <span class="n">unsigned</span> <span class="nb">int</span> <span class="n">inputValueReferences</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">};</span>
</pre></div>
</div>
<p>The outputs of EnergyPlus will be</p>
<div class="code c highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">char</span> <span class="o">**</span> <span class="n">outputNames</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;basement,TRad&quot;</span><span class="p">,</span> <span class="s2">&quot;basement,QConSen_flow&quot;</span><span class="p">,</span> <span class="s2">&quot;basement,QLat_flow&quot;</span><span class="p">,</span> <span class="s2">&quot;basement,QPeo_flow&quot;</span><span class="p">,</span>
                             <span class="s2">&quot;office,TRad&quot;</span><span class="p">,</span> <span class="s2">&quot;office,QConSen_flow&quot;</span><span class="p">,</span> <span class="s2">&quot;office,QLat_flow&quot;</span><span class="p">,</span> <span class="s2">&quot;office,QPeo_flow&quot;</span><span class="p">};</span>
<span class="n">const</span> <span class="n">unsigned</span> <span class="nb">int</span> <span class="n">outputValueReferences</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">17</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">};</span>
</pre></div>
</div>
<p>This function will read the <code class="docutils literal notranslate"><span class="pre">idf</span></code> file and sets up the data structure in EnergyPlus.</p>
<p>It returns zero if there was no error, or else a positive non-zero integer.</p>
</div>
<div class="section" id="setting-up-the-experiment-time">
<h4>5.2.5.3. Setting up the experiment time<a class="headerlink" href="#setting-up-the-experiment-time" title="Permalink to this headline">¶</a></h4>
<div class="code c highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">unsigned</span> <span class="nb">int</span> <span class="n">setupExperiment</span><span class="p">(</span><span class="n">double</span> <span class="n">tStart</span><span class="p">,</span>
                             <span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">log</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">tStart</span></code>: Start of simulation in seconds.</li>
<li><code class="docutils literal notranslate"><span class="pre">log</span></code>: Logging message returned on error.</li>
</ul>
<p>This functions sets the start time of EnergyPlus to the value <code class="docutils literal notranslate"><span class="pre">tStart</span></code>.
There is no warm-up simulation. EnergyPlus will continue the simulation until
<code class="docutils literal notranslate"><span class="pre">terminate(const</span> <span class="pre">char</span> <span class="pre">*)</span></code> (see below) is called.</p>
<p>It returns zero if there was no error, or else a positive non-zero integer.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The EnergyPlus start time is as retrieved from the argument of
<code class="docutils literal notranslate"><span class="pre">setupExperiment(...)</span></code>. The <code class="docutils literal notranslate"><span class="pre">RunPeriod</span></code> in the <code class="docutils literal notranslate"><span class="pre">idf</span></code> file is only
used to determine the day of the week.</p>
<p><em>Possible complication</em>:</p>
<p class="last">Users may set <code class="docutils literal notranslate"><span class="pre">tStart</span></code>
to a time other than midnight. We think EnergyPlus cannot yet handle an arbitrary start time.
In this case, it should return an error.</p>
</div>
</div>
<div class="section" id="setting-the-current-time">
<h4>5.2.5.4. Setting the current time<a class="headerlink" href="#setting-the-current-time" title="Permalink to this headline">¶</a></h4>
<div class="code c highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">unsigned</span> <span class="nb">int</span> <span class="n">setTime</span><span class="p">(</span><span class="n">double</span> <span class="n">time</span><span class="p">,</span>
                     <span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">log</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">time</span></code>: Model time.</li>
<li><code class="docutils literal notranslate"><span class="pre">log</span></code>: Logging message returned on error.</li>
</ul>
<p>This function sets a new time in EnergyPlus. This time becomes the current model time.</p>
<p>It returns zero if there was no error, or else a positive non-zero integer.</p>
</div>
<div class="section" id="sending-parameters-and-variables-to-energyplus">
<h4>5.2.5.5. Sending parameters and variables to EnergyPlus<a class="headerlink" href="#sending-parameters-and-variables-to-energyplus" title="Permalink to this headline">¶</a></h4>
<div class="code c highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">unsigned</span> <span class="nb">int</span> <span class="n">setVariables</span><span class="p">(</span><span class="n">const</span> <span class="n">unsigned</span> <span class="nb">int</span> <span class="n">valueReferences</span><span class="p">[],</span>
                          <span class="n">const</span> <span class="n">double</span><span class="o">*</span> <span class="n">const</span> <span class="n">variablePointers</span><span class="p">[],</span>
                          <span class="n">size_t</span> <span class="n">nVars1</span><span class="p">,</span>
                          <span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">log</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">valueReferences</span></code>: Vector of value references.</li>
<li><code class="docutils literal notranslate"><span class="pre">variablePointers</span></code>: Vector of pointers to variables.</li>
<li><code class="docutils literal notranslate"><span class="pre">nVars1</span></code>: Number of elements of <code class="docutils literal notranslate"><span class="pre">valueReferences</span></code>, and <code class="docutils literal notranslate"><span class="pre">variablePointers</span></code>.</li>
<li><code class="docutils literal notranslate"><span class="pre">log</span></code>: Logging message returned on error.</li>
</ul>
<p>This function sets the value of variables in EnergyPlus.
The vector <code class="docutils literal notranslate"><span class="pre">valueReferences</span></code> could be a subset of the pointer <code class="docutils literal notranslate"><span class="pre">inputValueReferences</span></code>
that was setup in <code class="docutils literal notranslate"><span class="pre">instantiate(...)</span></code>, i.e., <code class="docutils literal notranslate"><span class="pre">nVars1</span> <span class="pre">&lt;=</span> <span class="pre">nInp</span></code>
(to allow updating only specific variables
as needed by QSS).</p>
<p>It returns zero if there was no error, or else a positive non-zero integer.</p>
</div>
<div class="section" id="retrieving-parameters-and-variables-from-energyplus">
<h4>5.2.5.6. Retrieving parameters and variables from EnergyPlus<a class="headerlink" href="#retrieving-parameters-and-variables-from-energyplus" title="Permalink to this headline">¶</a></h4>
<div class="code c highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">unsigned</span> <span class="nb">int</span> <span class="n">getVariables</span><span class="p">(</span><span class="n">const</span> <span class="n">unsigned</span> <span class="nb">int</span> <span class="n">valueReferences</span><span class="p">[],</span>
                          <span class="n">const</span> <span class="n">double</span><span class="o">*</span> <span class="n">variablePointers</span><span class="p">[],</span>
                          <span class="n">size_t</span> <span class="n">nVars2</span><span class="p">,</span>
                          <span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">log</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">valueReferences</span></code>: Vector of value references.</li>
<li><code class="docutils literal notranslate"><span class="pre">variablePointers</span></code>: Vector of pointers to variables.</li>
<li><code class="docutils literal notranslate"><span class="pre">nVars2</span></code>: Number of elements of <code class="docutils literal notranslate"><span class="pre">valueReferences</span></code>, and <code class="docutils literal notranslate"><span class="pre">variablePointers</span></code>.</li>
<li><code class="docutils literal notranslate"><span class="pre">log</span></code>: Logging message returned on error.</li>
</ul>
<p>This function gets the value of variables in EnergyPlus.
EnergyPlus must write the values to the elements that are setup in <code class="docutils literal notranslate"><span class="pre">outputValueReferences</span></code>
during the <code class="docutils literal notranslate"><span class="pre">instantiate(...)</span></code> call.
<code class="docutils literal notranslate"><span class="pre">nVars2</span> <span class="pre">&lt;=</span> <span class="pre">nOut</span></code> if only certain output variables are required.</p>
<p>It returns zero if there was no error, or else a positive non-zero integer.</p>
</div>
<div class="section" id="retrieving-the-next-event-time">
<h4>5.2.5.7. Retrieving the next event time<a class="headerlink" href="#retrieving-the-next-event-time" title="Permalink to this headline">¶</a></h4>
<div class="code c highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">unsigned</span> <span class="nb">int</span> <span class="n">getNextEventTime</span><span class="p">(</span><span class="n">fmi2EventInfo</span> <span class="o">*</span><span class="n">eventInfo</span><span class="p">,</span>
                              <span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">log</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">eventInfo</span></code>: A structure with event info as defined in section <a class="reference internal" href="#sec-time-sync"><span class="std std-ref">Time synchronization</span></a></li>
<li><code class="docutils literal notranslate"><span class="pre">log</span></code>: Logging message returned on error.</li>
</ul>
<p>This function writes a structure which contains among its variables a non-zero flag to indicate that the next event time is defined, and the next event time in EnergyPlus.</p>
<p>It returns zero if there was no error, or else a positive non-zero integer.</p>
</div>
<div class="section" id="terminating-the-energyplus-simulation">
<h4>5.2.5.8. Terminating the EnergyPlus simulation<a class="headerlink" href="#terminating-the-energyplus-simulation" title="Permalink to this headline">¶</a></h4>
<div class="code c highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">unsigned</span> <span class="nb">int</span> <span class="n">terminate</span><span class="p">(</span><span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">log</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">log</span></code>: Logging message returned on error.</li>
</ul>
<p>This function must free all allocated variables in EnergyPlus.</p>
<p>Any further call to the EnergyPlus shared library is prohibited after call to this function.</p>
<p>It returns zero if there was no error, or else a positive non-zero integer.</p>
</div>
<div class="section" id="writing-energyplus-output-files">
<h4>5.2.5.9. Writing EnergyPlus output files<a class="headerlink" href="#writing-energyplus-output-files" title="Permalink to this headline">¶</a></h4>
<div class="code c highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">unsigned</span> <span class="nb">int</span> <span class="n">writeOutputFiles</span><span class="p">(</span><span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">log</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">log</span></code>: Logging message returned on error.</li>
</ul>
<p>This function writes the output to the EnergyPlus output files.</p>
<p>It returns zero if there was no error, or else a positive non-zero integer.</p>
</div>
</div>
<div class="section" id="pseudo-code-example">
<h3>5.2.6. Pseudo Code Example<a class="headerlink" href="#pseudo-code-example" title="Permalink to this headline">¶</a></h3>
<p>In the next section, the usage of the FMI functions along with the equivalent EnergyPlus functions are used in a typical calling sequence.
This should clarify the need of the EnergyPlus equivalent functions and show how these functions will be used in a simulation environment.
In the pseudo code, <code class="docutils literal notranslate"><span class="pre">-&gt;</span></code> points to the EnergyPlus equivalent FMI functions. <code class="docutils literal notranslate"><span class="pre">NA</span></code> indicates that the FMI functions do not require EnergyPlus equivalent.</p>
<div class="highlight-C notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="c1">// instantiate</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">M_fmi2Instantiate</span><span class="p">(...)</span> <span class="o">-&gt;</span> <span class="n">instantiate</span><span class="p">(...)</span>

    <span class="n">tStart</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">tEnd</span>   <span class="o">=</span> <span class="mi">10</span>
    <span class="n">dt</span>     <span class="o">=</span> <span class="mf">0.01</span>

    <span class="c1">// set the start time</span>
    <span class="n">time</span>  <span class="o">=</span> <span class="n">tStart</span>

    <span class="c1">// set the input values and the initial values for the states at time = tStart</span>
    <span class="n">M_fmi2SetReal</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="p">...)</span> <span class="o">-&gt;</span> <span class="n">setVariables</span> <span class="p">(...)</span>

    <span class="c1">// initialize. Note that tEnd is not set in M_fmi2SetupExperiment</span>
    <span class="n">M_fmi2SetupExperiment</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">fmi2False</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">Tstart</span><span class="p">,</span> <span class="n">fmi2False</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">setupExperiment</span><span class="p">(...)</span>
    <span class="n">M_fmi2EnterInitializationMode</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NA</span>
    <span class="n">M_fmi2ExitInitializationMode</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NA</span>

    <span class="n">initialEventMode</span> <span class="o">=</span> <span class="n">fmi2True</span>
    <span class="n">enterEventMode</span> <span class="o">=</span> <span class="n">fmi2False</span>
    <span class="n">timeEvent</span> <span class="o">=</span> <span class="n">fmi2False</span>
    <span class="n">stateEvent</span> <span class="o">=</span> <span class="n">fmi2False</span>
    <span class="n">previous_z</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">nz</span><span class="p">)</span>

    <span class="c1">// The time in EnergyPlus is now at Tstart</span>

    <span class="k">do</span>
      <span class="c1">// handle events</span>
      <span class="k">if</span> <span class="n">initialEventMode</span> <span class="n">or</span> <span class="n">enterEventMode</span> <span class="n">or</span> <span class="n">timeEvent</span> <span class="n">or</span> <span class="n">stateEvent</span> <span class="n">then</span>
        <span class="k">if</span> <span class="n">not</span> <span class="n">initialEventMode</span> <span class="n">then</span>
          <span class="n">M_fmi2EnterEventMode</span><span class="p">(...)</span> <span class="o">-&gt;</span> <span class="n">NA</span>
        <span class="n">end</span> <span class="k">if</span>

        <span class="c1">// event iteration</span>
        <span class="n">eventInfo</span><span class="p">.</span><span class="n">newDiscreteStatesNeeded</span> <span class="o">=</span> <span class="n">fmi2True</span><span class="p">;</span>
        <span class="n">M_valuesOfContinuousStatesChanged</span> <span class="o">=</span> <span class="n">fmi2False</span><span class="p">;</span>
         <span class="k">while</span> <span class="n">eventInfo</span><span class="p">.</span><span class="n">newDiscreteStatesNeeded</span> <span class="n">loop</span>
           <span class="c1">// update discrete states</span>
           <span class="n">M_fmi2NewDiscreteStates</span><span class="p">(</span><span class="n">eventInfo</span><span class="p">,</span> <span class="p">...)</span> <span class="o">-&gt;</span> <span class="n">getNextEventTime</span><span class="p">(</span><span class="n">eventInfo</span><span class="p">,</span> <span class="p">...)</span>
           <span class="c1">// See specification on page 80</span>
           <span class="n">M_fmi2SetReal</span><span class="p">(...)</span> <span class="o">-&gt;</span> <span class="n">setVariables</span> <span class="p">(...)</span>
           <span class="n">M_fmi2GetReal</span><span class="p">(...)</span> <span class="o">-&gt;</span> <span class="n">getVariables</span> <span class="p">(...)</span>
           <span class="k">if</span> <span class="n">eventInfo</span><span class="p">.</span><span class="n">terminateSimulation</span> <span class="n">then</span> <span class="k">goto</span> <span class="n">TERMINATE_MODEL</span>
        <span class="n">end</span> <span class="k">while</span>

        <span class="c1">// enter Continuous-Time Mode</span>
        <span class="n">M_fmi2EnterContinuousTimeMode</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NA</span>

        <span class="c1">// retrieve solution at simulation (re)start</span>
        <span class="n">M_fmi2GetReal</span><span class="p">(...)</span> <span class="o">-&gt;</span> <span class="n">getVariables</span> <span class="p">(...)</span>
        <span class="k">if</span> <span class="n">initialEventMode</span> <span class="n">or</span> <span class="n">eventInfo</span><span class="p">.</span><span class="n">valuesOfContinuousStatesChanged</span> <span class="n">then</span>
          <span class="c1">//the model signals a value change of states, retrieve them</span>
          <span class="n">M_fmi2GetContinuousStates</span><span class="p">(...)</span> <span class="o">-&gt;</span> <span class="n">NA</span>
        <span class="n">end</span> <span class="k">if</span>

        <span class="k">if</span> <span class="n">initialEventMode</span> <span class="n">or</span> <span class="n">eventInfo</span><span class="p">.</span><span class="n">nominalsOfContinuousStatesChanged</span> <span class="n">then</span>
          <span class="c1">//the meaning of states has changed; retrieve new nominal values</span>
          <span class="n">M_fmi2GetNominalsOfContinuousStates</span><span class="p">(...)</span> <span class="o">-&gt;</span> <span class="n">NA</span>
        <span class="n">end</span> <span class="k">if</span>

        <span class="k">if</span> <span class="n">eventInfo</span><span class="p">.</span><span class="n">nextEventTimeDefined</span> <span class="n">then</span>
           <span class="n">tNext</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">eventInfo</span><span class="p">.</span><span class="n">nextEventTime</span><span class="p">,</span> <span class="n">tEnd</span><span class="p">)</span>
        <span class="k">else</span>
           <span class="n">tNext</span> <span class="o">=</span> <span class="n">tEnd</span>
        <span class="n">end</span> <span class="k">if</span>

        <span class="n">initialEventMode</span> <span class="o">=</span> <span class="n">fmi2False</span>
      <span class="n">end</span> <span class="k">if</span>

      <span class="k">if</span> <span class="n">time</span> <span class="o">&gt;=</span> <span class="n">tEnd</span> <span class="n">then</span>
        <span class="k">goto</span> <span class="n">TERMINATE_MODEL</span>
      <span class="n">end</span> <span class="k">if</span>

      <span class="c1">// compute derivatives</span>
      <span class="n">M_fmi2GetDerivatives</span><span class="p">(...)</span> <span class="o">-&gt;</span> <span class="n">NA</span>
      <span class="c1">// Note we might have to compute time derivatives at different time instants</span>
      <span class="c1">// to approximate higher order derivatives for QSS integration methods.</span>

      <span class="c1">// Note that a forward Euler method with event detection, or more sophisticated</span>
      <span class="c1">// methods such as dassl, will not work with EnergyPlus.</span>
      <span class="c1">// The reason is that EnergyPlus does not allow rollback (and this limitation</span>
      <span class="c1">// is indicated in the model description file with the capability flag</span>
      <span class="c1">// canGetAndSetFMUstate=false.</span>

      <span class="c1">// When using QSS numerical methods,</span>
      <span class="c1">// compute minimal next quantization time tq</span>
      <span class="n">time_old</span> <span class="o">=</span> <span class="n">time</span>
      <span class="n">time</span> <span class="o">=</span> <span class="n">min</span> <span class="p">(</span><span class="n">tq</span><span class="p">,</span> <span class="n">tNext</span><span class="p">)</span> <span class="c1">// tq is the next predicted quantization time</span>

      <span class="n">M_fmi2SetTime</span><span class="p">(...)</span> <span class="o">-&gt;</span> <span class="n">setTime</span><span class="p">(...)</span>

      <span class="c1">// set inputs at t = time</span>
      <span class="n">M_fmi2SetReal</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="p">...)</span> <span class="o">-&gt;</span> <span class="n">setVariables</span> <span class="p">(...)</span>

      <span class="c1">// do a time integration up to t = time</span>
      <span class="n">x</span> <span class="o">=</span> <span class="n">integral</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">der_x</span><span class="p">,</span> <span class="n">time_old</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
      <span class="n">M_fmi2SetContinuousStates</span><span class="p">(...)</span> <span class="o">-&gt;</span> <span class="n">NA</span>

      <span class="c1">// get event indicators for state events detection at t = time</span>
      <span class="n">M_fmi2GetEventIndicators</span><span class="p">(...)</span> <span class="o">-&gt;</span> <span class="n">NA</span>

      <span class="c1">// EnergyPlus has no zero crossing functions, hence</span>
      <span class="c1">// there is no state event detection for this FMU.</span>

      <span class="c1">// inform the model about an accepted step</span>
      <span class="c1">// To ensure that EnergyPlus call getNextEventTime(...),</span>
      <span class="c1">// enterEventMode will be set to true in M_fmi2CompletedIntegratorStep().</span>
      <span class="c1">// Furthermore, the capability flag completedIntegratorStepNotNeeded</span>
      <span class="c1">// will be set to false to ensure that this function is called</span>
      <span class="c1">// after an accepted step.</span>
      <span class="n">M_fmi2CompletedIntegratorStep</span><span class="p">(</span><span class="n">enterEventMode</span><span class="p">...)</span> <span class="o">-&gt;</span> <span class="n">writeOutputFiles</span><span class="p">(...)</span>

      <span class="c1">// get the outputs</span>
      <span class="n">M_fmi2GetReal</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="p">...)</span> <span class="o">-&gt;</span> <span class="n">getVariables</span> <span class="p">(...)</span>

    <span class="n">until</span> <span class="n">terminateSimulation</span>

    <span class="c1">// terminate simulation and retrieve final values</span>
    <span class="nl">TERMINATE_MODEL</span><span class="p">:</span>
    <span class="n">M_fmi2GetReal</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="p">...)</span> <span class="o">-&gt;</span> <span class="n">getVariables</span><span class="p">()</span>
    <span class="n">M_fmi2Terminate</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">terminate</span><span class="p">(...)</span>


    <span class="c1">// cleanup</span>
    <span class="n">M_fmi2FreeInstance</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NA</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="tool-for-exporting-energyplus-as-an-fmu">
<h3>5.2.7. Tool for Exporting EnergyPlus as an FMU<a class="headerlink" href="#tool-for-exporting-energyplus-as-an-fmu" title="Permalink to this headline">¶</a></h3>
<p>To export EnergyPlus as an FMU, a utility is needed which will get as inputs
the paths to the EnergyPlus idf, idd, and weather files.
The utility will parse the idf file and write an XML model description file
which contains the inputs, outputs, and states of EnergyPlus to be exposed
through the FMI interface.
The utility will compile the EnergyPlus FMI functions into a shared library,
and package the library with the idf, idd, and weather file in the
<code class="docutils literal notranslate"><span class="pre">resources</span></code> folder of the FMU.
An approach to develop such a utility is to extend EnergyPlusToFMU
(<a class="reference external" href="http://simulationresearch.lbl.gov/fmu/EnergyPlus/export/index.html">http://simulationresearch.lbl.gov/fmu/EnergyPlus/export/index.html</a>)
to support FMI 2.0 for model exchange.
Another approach is to extend SimulatorToFMU (<a class="reference external" href="https://github.com/LBNL-ETA/SimulatorToFMU">https://github.com/LBNL-ETA/SimulatorToFMU</a>)
to support the export of EnergyPlus.</p>
</div>
</div>
<div class="section" id="jmodelica-integration">
<h2>5.3. JModelica Integration<a class="headerlink" href="#jmodelica-integration" title="Permalink to this headline">¶</a></h2>
<p>This section describes the integration of the QSS solver in JModelica.</p>
<p>We will first introduce terminology.
Consider the code-snippet</p>
<div class="highlight-modelica notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="kr">when</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">a</span><span class="p">)</span> <span class="kr">then</span>
  <span class="o">...</span>
<span class="kr">end</span> <span class="kr">when</span><span class="p">;</span>
<span class="o">...</span>
</pre></div>
</div>
<p>We will say that <span class="math notranslate nohighlight">\(z = a - x\)</span> is the <em>event indicator</em>.</p>
<p>For the discussion, we consider a system of initial value ODEs of the form</p>
<div class="math notranslate nohighlight" id="equation-eqn-ini-val">
<span class="eqno">(5.1)<a class="headerlink" href="#equation-eqn-ini-val" title="Permalink to this equation">¶</a></span>\[ \begin{align}\begin{aligned}\left[\dot x_c(t), x_d(t)\right] = f(x_c(t), x_d(t^-), u_c(t), u_d(t), p, t),\\\begin{split}\left[y_c(t), y_d(t)\right]  = g(x_c(t), x_d(t), u_c(t), u_d(t), p, t),\\\end{split}\\\begin{split}0          = z(x_c(t), x_d(t), u_c(t), u_d(t), p, t),\\\end{split}\\\left[x_c(t_0), x_d(t_0)\right]  = [x_{c,0}, x_{d,0}],\end{aligned}\end{align} \]</div>
<p>where
<span class="math notranslate nohighlight">\(x(\cdot)\)</span> is the continuous-time state vector, with superscript
<span class="math notranslate nohighlight">\(c\)</span> denoting continuous-time states and <span class="math notranslate nohighlight">\(d\)</span> denoting discrete variables or states,
<span class="math notranslate nohighlight">\(u(\cdot)\)</span> is the external input,
<span class="math notranslate nohighlight">\(p\)</span> are parameters,
<span class="math notranslate nohighlight">\(f(\cdot, \cdot, \cdot, \cdot, \cdot, \cdot)\)</span> is the state transitions function,
<span class="math notranslate nohighlight">\(g(\cdot, \cdot, \cdot, \cdot, \cdot, \cdot)\)</span> is the output function,
<span class="math notranslate nohighlight">\(z(\cdot, \cdot, \cdot, \cdot, \cdot, \cdot)\)</span> is the event indicator (sometimes called zero crossing function).</p>
<p>Because we anticipate that the FMU can have
direct feed-through from the input
<span class="math notranslate nohighlight">\(u(t)\)</span> to the output <span class="math notranslate nohighlight">\(y(t)\)</span>, we use
FMI for Model-Exchange (FMI-ME) version 2.0, because the Co-Simulation
standard does not allow a zero time step size as needed for direct feed-through.</p>
<p><a class="reference internal" href="#fig-sof-arc-qss-jmod2"><span class="std std-numref">Fig. 5.3</span></a> shows the software architecture
with the extended FMI API.
For simplicity the figure only
shows single FMUs, but we anticipated having multiple interconnected FMUs.</p>
<div class="figure" id="id14">
<span id="fig-sof-arc-qss-jmod2"></span><p class="plantuml">
<object data="_images/plantuml-24c6e5725ea55a6b194775fd3c024e2e3075f32d.svg" type="image/svg+xml" style="width:874px;height:981px;">
<img src="_images/plantuml-24c6e5725ea55a6b194775fd3c024e2e3075f32d.png" alt="title Software architecture for QSS integration with JModelica with extended FMI API

skinparam componentStyle uml2

package FMU-QSS {
  [QSS solver] as qss_sol
  [FMU-ME] as FMU_QSS
}

package PyFMI {
[Master algorithm] -&gt; qss_sol : &quot;inputs, time&quot;
[Master algorithm] &lt;- qss_sol : &quot;next event time, discrete states&quot;
[Master algorithm] - [Sundials]
}

[FMU-ME] as ode

[Sundials] -&gt; ode : &quot;(x, t)&quot;
[Sundials] &lt;- ode : &quot;dx/dt&quot;

package Optimica {
[JModelica compiler] as jmc
}

jmc -l-&gt; FMU_QSS

FMU_QSS -down-&gt; qss_sol : &quot;derivatives&quot;
qss_sol -down-&gt; FMU_QSS : &quot;inputs, time, states&quot;"/>

</object></p>
<p class="caption"><span class="caption-number">Fig. 5.3 </span>: Software architecture for QSS integration with JModelica
with extended FMI API.<a class="headerlink" href="#id14" title="Permalink to this image">¶</a></p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">We still need to design how to handle algebraic loops inside the FMU
(see also Cellier’s and Kofman’s book) and algebraic loops that
cross multiple FMUs.</p>
</div>
<p>The QSS solvers require the derivatives shown in <a class="reference internal" href="#tab-qss-der"><span class="std std-numref">Table 5.1</span></a>.</p>
<span id="tab-qss-der"></span><table border="1" class="docutils" id="id15">
<caption><span class="caption-number">Table 5.1 </span><span class="caption-text">Derivatives required by QSS algorithms. One asteriks indicates
        that they are provided by FMI-ME 2.0, and two asteriks indicate
        that they can optionally be computed exactly if directional
        derivatives are provided by the FMU.
        The others cannot be provided through the FMI API.</span><a class="headerlink" href="#id15" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="50%" />
<col width="40%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Type of QSS</th>
<th class="head">Continuous-time state derivative</th>
<th class="head">event indicator derivative</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>QSS1</td>
<td><span class="math notranslate nohighlight">\(dx_c/dt\)</span> *</td>
<td><span class="math notranslate nohighlight">\(dz/dt\)</span></td>
</tr>
<tr class="row-odd"><td>QSS2</td>
<td><span class="math notranslate nohighlight">\(dx_c/dt\)</span> * , <span class="math notranslate nohighlight">\(d^2x_c/dt^2\)</span> **</td>
<td><span class="math notranslate nohighlight">\(dz/dt\)</span> , <span class="math notranslate nohighlight">\(d^2z/dt^2\)</span></td>
</tr>
<tr class="row-even"><td>QSS3</td>
<td><span class="math notranslate nohighlight">\(dx_c/dt\)</span> * , <span class="math notranslate nohighlight">\(d^2x_c/dt^2\)</span> ** , <span class="math notranslate nohighlight">\(d^3x_c/dt^3\)</span></td>
<td><span class="math notranslate nohighlight">\(dz/dt\)</span> , <span class="math notranslate nohighlight">\(d^2z/dt^2\)</span>, <span class="math notranslate nohighlight">\(d^3z/dt^3\)</span></td>
</tr>
</tbody>
</table>
<p>Because the FMI API does not provide access to the required derivatives,
and FMI has limited support for QSS, we discuss extensions
that are needed for an efficient implementation of QSS.</p>
<div class="section" id="fmi-changes-for-qss">
<h3>5.3.1. FMI Changes for QSS<a class="headerlink" href="#fmi-changes-for-qss" title="Permalink to this headline">¶</a></h3>
<p>QSS generally requires to only update a subset of the continuous-time state vector. We therefore
propose to use the function</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">fmi2Status</span> <span class="nf">fmi2SetReal</span><span class="p">(</span><span class="n">fmi2Component</span> <span class="n">c</span><span class="p">,</span>
                       <span class="k">const</span> <span class="n">fmi2Real</span> <span class="n">x</span><span class="p">[],</span>
                       <span class="k">const</span> <span class="n">fmi2ValueReference</span> <span class="n">vr</span><span class="p">[],</span>
                       <span class="kt">size_t</span> <span class="n">nx</span><span class="p">);</span>
</pre></div>
</div>
<p>to set a subset of the continuous-time state vector.
This function exists in FMI-ME 2.0, but the standard only allows to call it for
continuous-time state variables during the initialization.</p>
<p>We therefore propose that the standard is being changed as follows:</p>
<blockquote>
<div><code class="docutils literal notranslate"><span class="pre">fmi2SetReal</span></code> can be called during the continuous time mode
and during event mode not only for inputs,
as is allowed in FMI-ME 2.0, but also for continuous-time states.</div></blockquote>
<p>To retrieve individual state derivatives, we introduce the extensions
shown in <a class="reference internal" href="#fig-der-ext"><span class="std std-numref">Listing 5.1</span></a>
to the <code class="docutils literal notranslate"><span class="pre">&lt;Derivatives&gt;</span></code> element of the <code class="docutils literal notranslate"><span class="pre">modelDescription.xml</span></code> file.</p>
<div class="literal-block-wrapper docutils container" id="id16">
<span id="fig-der-ext"></span><div class="code-block-caption"><span class="caption-number">Listing 5.1 </span><span class="caption-text">Extensions for obtaining higher order state derivatives. XML additions are marked yellow.</span><a class="headerlink" href="#id16" title="Permalink to this code">¶</a></div>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span> &lt;ModelVariables&gt; &lt;!-- Remains unchanged --&gt;
   ...
   &lt;ScalarVariable name=&quot;x&quot;,      ...&gt; ... &lt;/ScalarVariable&gt; &lt;!-- index=&quot;5&quot; --&gt;
   ...
   &lt;ScalarVariable name=&quot;der(x)&quot;, ...&gt; ... &lt;/ScalarVariable&gt; &lt;!-- index=&quot;8&quot; --&gt;
 &lt;/ModelVariables&gt;

 &lt;Derivatives&gt;
   &lt;!-- The ScalarVariable with index 8 is der(x) --&gt;
   &lt;Unknown     index=&quot;8&quot; dependencies=&quot;6&quot; /&gt;
   &lt;!-- index 5 is the index of the state variable x --&gt;
<span class="hll">   &lt;HigherOrder index=&quot;5&quot; order=&quot;2&quot; valueReference=&quot;124&quot; /&gt; &lt;!-- This is d^2 x/dt^2 --&gt;
</span><span class="hll">   &lt;HigherOrder index=&quot;5&quot; order=&quot;3&quot; valueReference=&quot;125&quot; /&gt; &lt;!-- This is d^3 x/dt^3 --&gt;
</span> &lt;/Derivatives&gt;
</pre></div>
</div>
</div>
<div class="section" id="event-handling">
<h4>5.3.1.1. Event Handling<a class="headerlink" href="#event-handling" title="Permalink to this headline">¶</a></h4>
<div class="section" id="state-events">
<span id="subsec-se"></span><h5>5.3.1.1.1. State Events<a class="headerlink" href="#state-events" title="Permalink to this headline">¶</a></h5>
<p>For efficiency, QSS requires to know the dependencies
of event indicators. Also, it will need to
have access to, or else approximate numerically, the time derivatives of the
event indicator. FMI 2.0 outputs an array of real-valued event indicators,
but no variable dependencies.</p>
<p>Therefore, we introduce the following xml section, which assumes we have
three event indicators.</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;ModelStructure&gt;</span>
  <span class="nt">&lt;EventIndicators&gt;</span>
    <span class="c">&lt;!-- This is z[0] which depends on ScalarVariable with index 2 and 3 --&gt;</span>
    <span class="nt">&lt;Element</span> <span class="na">index=</span><span class="s">&quot;1&quot;</span> <span class="na">order=</span><span class="s">&quot;0&quot;</span> <span class="na">dependencies=</span><span class="s">&quot;2 3&quot;</span> <span class="na">valueReference=</span><span class="s">&quot;200&quot;</span> <span class="nt">/&gt;</span>
    <span class="c">&lt;!-- This is z[1] which declares no dependencies, hence it may depend on everything --&gt;</span>
    <span class="nt">&lt;Element</span> <span class="na">index=</span><span class="s">&quot;2&quot;</span> <span class="na">order=</span><span class="s">&quot;0&quot;</span> <span class="na">valueReference=</span><span class="s">&quot;201&quot;</span> <span class="nt">/&gt;</span>
     <span class="c">&lt;!-- This is z[2] which declares that it depends only on time --&gt;</span>
    <span class="nt">&lt;Element</span> <span class="na">index=</span><span class="s">&quot;3&quot;</span> <span class="na">order=</span><span class="s">&quot;0&quot;</span> <span class="na">dependencies=</span><span class="s">&quot;&quot;</span> <span class="na">valueReference=</span><span class="s">&quot;202&quot;</span> <span class="nt">/&gt;</span>

    <span class="c">&lt;!-- With order &gt; 0, higher order derivatives can be specified. --&gt;</span>
    <span class="c">&lt;!-- This is dz[0]/dt --&gt;</span>
    <span class="nt">&lt;Element</span> <span class="na">index=</span><span class="s">&quot;1&quot;</span> <span class="na">order=</span><span class="s">&quot;1&quot;</span> <span class="na">valueReference=</span><span class="s">&quot;210&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/EventIndicators&gt;</span>
<span class="nt">&lt;/ModelStructure&gt;</span>
</pre></div>
</div>
<p>The attribute <code class="docutils literal notranslate"><span class="pre">dependencies</span></code> is optional. However, if it is not specified,
a tool shall assume that the event indicator depends on all variables.
Write <code class="docutils literal notranslate"><span class="pre">dependencies=&quot;&quot;</span></code> to declare that this event indicator depends on no variable
(other than possibly time).
Note that for performance reasons, for QSS <code class="docutils literal notranslate"><span class="pre">dependencies</span></code> should be declared
for <code class="docutils literal notranslate"><span class="pre">order=&quot;0&quot;</span></code>. For higher order, QSS does not use the dependencies.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">index</span></code> uses in the <code class="docutils literal notranslate"><span class="pre">&lt;EventIndicators&gt;</span></code> element is different from the <code class="docutils literal notranslate"><span class="pre">index</span></code>
used in the <code class="docutils literal notranslate"><span class="pre">&lt;ModelVariables&gt;</span></code> element. The first event indicator has an <code class="docutils literal notranslate"><span class="pre">index</span></code> 1,
the second has an <code class="docutils literal notranslate"><span class="pre">index</span></code> 2, and so on. A new index is introduced because the event
indicators do not show up in the list of <code class="docutils literal notranslate"><span class="pre">&lt;ModelVariables&gt;</span></code>.</p>
<p>The dependencies variables of event indicators are</p>
<ul class="last simple">
<li>inputs (variables with causality = “input”)</li>
<li>continuous-time states</li>
<li>independent variable (usually time; causality = “independent”)</li>
</ul>
</div>
<p>Consider the following model</p>
<div class="highlight-modelica notranslate"><div class="highlight"><pre><span></span><span class="kr">within</span> <span class="nn">QSS</span><span class="o">.</span><span class="n">Docs</span><span class="p">;</span>
<span class="kr">model</span> <span class="nc">StateEvent1</span> <span class="s2">&quot;This model tests state event detection&quot;</span>
  <span class="kr">extends</span> <span class="n">Modelica</span><span class="o">.</span><span class="n">Icons</span><span class="o">.</span><span class="n">Example</span><span class="p">;</span>
  <span class="nb">Real</span> <span class="n">x1</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">true</span><span class="p">)</span> <span class="s2">&quot;State variable&quot;</span><span class="p">;</span>
  <span class="nb">Real</span> <span class="n">x2</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">true</span><span class="p">)</span> <span class="s2">&quot;State variable&quot;</span><span class="p">;</span>
  <span class="kr">discrete</span> <span class="n">Modelica</span><span class="o">.</span><span class="n">Blocks</span><span class="o">.</span><span class="n">Interfaces</span><span class="o">.</span><span class="n">RealOutput</span> <span class="n">y</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">true</span><span class="p">)</span>
    <span class="s2">&quot;Ouput variable&quot;</span><span class="p">;</span>
<span class="kr">equation</span>
  <span class="kr">der</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kr">der</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span> <span class="o">=</span> <span class="n">x2</span><span class="p">;</span>
  <span class="kr">when</span> <span class="p">(</span><span class="n">x1</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="ow">and</span> <span class="n">x2</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">)</span> <span class="kr">then</span>
    <span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">;</span>
  <span class="kr">end</span> <span class="kr">when</span><span class="p">;</span>
  <span class="kr">annotation</span> <span class="p">(</span><span class="n">experiment</span><span class="p">(</span><span class="n">StopTime</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">Documentation</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="s2">&quot;</span><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
This model has 2 state events, one at t=0.25
and one at t=0.6924 when simulated from 0 to 1 s.
<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span><span class="s2">&quot;</span><span class="p">));</span>
<span class="kr">end</span> <span class="nc">StateEvent1</span><span class="p">;</span>
</pre></div>
</div>
<p>For efficiency reason, QSS requires the FMU which exports this model to indicate in its model description file
the dependency of <code class="docutils literal notranslate"><span class="pre">der(x1)</span></code> on <code class="docutils literal notranslate"><span class="pre">y</span></code>. This allows <code class="docutils literal notranslate"><span class="pre">der(x1)</span></code> to update when <code class="docutils literal notranslate"><span class="pre">y</span></code> changes.
However, <code class="docutils literal notranslate"><span class="pre">y</span></code> can only change when an event indicator changes its domain. Hence,
rather than declaring the dependency on <code class="docutils literal notranslate"><span class="pre">y</span></code>, it suffices to declare the dependency on
the event indicator.
Therefore, we propose to
include event indicators to the list of state derivative dependencies.</p>
<p>However, FMI states on page 61 that <code class="docutils literal notranslate"><span class="pre">dependencies</span></code> are optional attributes
defining the dependencies of the unknown (directly or indirectly via auxiliary variables)
with respect to known.
For state derivatives and outputs, known variables are</p>
<ul class="simple">
<li>inputs (variables with causality = “input”)</li>
<li>continuous-time states</li>
<li>independent variable (usually time; causality = “independent”)</li>
</ul>
<p>Therefore we require to extend the <code class="docutils literal notranslate"><span class="pre">&lt;Derivatives&gt;</span></code> element
with a new attribute <code class="docutils literal notranslate"><span class="pre">eventIndicatorsDependencies</span></code> which lists
all event indicator variables which trigger
changes to state derivative trajectories.</p>
<p>An excerpt of such a <code class="docutils literal notranslate"><span class="pre">&lt;Derivatives&gt;</span></code> element with the new addition is
shown in <a class="reference internal" href="#fig-hig-der"><span class="std std-numref">Listing 5.2</span></a>.</p>
<div class="literal-block-wrapper docutils container" id="id17">
<span id="fig-hig-der"></span><div class="code-block-caption"><span class="caption-number">Listing 5.2 </span><span class="caption-text">Extensions with inclusion of a new attribute for event indicator dependencies. XML additions are marked yellow.</span><a class="headerlink" href="#id17" title="Permalink to this code">¶</a></div>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span>  <span class="nt">&lt;Derivatives&gt;</span>
    <span class="c">&lt;!-- The ScalarVariable with index 8 is der(x) --&gt;</span>
<span class="hll">    <span class="c">&lt;!-- eventIndicatorsDependencies=&quot;1&quot; declares that der(x)</span>
</span><span class="c">         depends on the event indicator with index 1  --&gt;</span>
    <span class="nt">&lt;Unknown</span>     <span class="na">index=</span><span class="s">&quot;8&quot;</span> <span class="na">dependencies=</span><span class="s">&quot;6&quot;</span> <span class="na">eventIndicatorsDependencies=</span><span class="s">&quot;1&quot;</span><span class="nt">/&gt;</span>
    <span class="c">&lt;!-- index 5 is the index of the state variable x --&gt;</span>
    <span class="nt">&lt;HigherOrder</span> <span class="na">index=</span><span class="s">&quot;5&quot;</span> <span class="na">order=</span><span class="s">&quot;2&quot;</span> <span class="na">valueReference=</span><span class="s">&quot;124&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- This is d^2 x/dt^2 --&gt;</span>
    <span class="nt">&lt;HigherOrder</span> <span class="na">index=</span><span class="s">&quot;5&quot;</span> <span class="na">order=</span><span class="s">&quot;3&quot;</span> <span class="na">valueReference=</span><span class="s">&quot;125&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- This is d^3 x/dt^3 --&gt;</span>
  <span class="nt">&lt;/Derivatives&gt;</span>
</pre></div>
</div>
</div>
<p>For the elements <code class="docutils literal notranslate"><span class="pre">Unknown</span></code> and <code class="docutils literal notranslate"><span class="pre">HigherOrder</span></code>, the
attributes <code class="docutils literal notranslate"><span class="pre">dependencies</span></code> and <code class="docutils literal notranslate"><span class="pre">eventIndicatorsDependencies</span></code> are optional.
However, if <code class="docutils literal notranslate"><span class="pre">dependencies</span></code> is not declared,
a tool shall assume that they
depend on all variables.
Similarly, if <code class="docutils literal notranslate"><span class="pre">eventIndicatorsDependencies</span></code> is not declared,
a tool shall assume that they
depend on all event indicators.
Write <code class="docutils literal notranslate"><span class="pre">dependencies=&quot;&quot;</span></code> to declare that this derivative depends on no variable.
Similarly,
write <code class="docutils literal notranslate"><span class="pre">eventIndicatorsDependencies=&quot;&quot;</span></code> to declare that this derivative depends on no event indicator.
Note that for performance reasons, for QSS <code class="docutils literal notranslate"><span class="pre">dependencies</span></code> and <code class="docutils literal notranslate"><span class="pre">eventIndicatorsDependencies</span></code> should be declared
for <code class="docutils literal notranslate"><span class="pre">Unknown</span></code>. For <code class="docutils literal notranslate"><span class="pre">HigherOrder</span></code>, QSS does not use the
<code class="docutils literal notranslate"><span class="pre">dependencies</span></code> and <code class="docutils literal notranslate"><span class="pre">eventIndicatorsDependencies</span></code>.</p>
<p>In <a class="reference internal" href="#fig-hig-der"><span class="std std-numref">Listing 5.2</span></a>, the higher order derivatives depend on the event indicator.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The indexes of <code class="docutils literal notranslate"><span class="pre">eventIndicatorsDependencies</span></code> are the indexes of the
event indicators specified in the <code class="docutils literal notranslate"><span class="pre">&lt;EventIndicators&gt;</span></code> element.</p>
</div>
</div>
<div class="section" id="event-indicators-that-depend-on-the-input">
<span id="subsec-te"></span><h5>5.3.1.1.2. Event indicators that depend on the input<a class="headerlink" href="#event-indicators-that-depend-on-the-input" title="Permalink to this headline">¶</a></h5>
<p>Consider following model</p>
<div class="highlight-modelica notranslate"><div class="highlight"><pre><span></span><span class="kr">within</span> <span class="nn">QSS</span><span class="o">.</span><span class="n">Docs</span><span class="p">;</span>
<span class="kr">model</span> <span class="nc">StateEvent2</span> <span class="s2">&quot;This model tests state event detection&quot;</span>
  <span class="kr">extends</span> <span class="n">Modelica</span><span class="o">.</span><span class="n">Icons</span><span class="o">.</span><span class="n">Example</span><span class="p">;</span>
  <span class="nb">Real</span> <span class="n">x</span><span class="p">(</span><span class="n">start</span><span class="o">=-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">true</span><span class="p">)</span> <span class="s2">&quot;State variable&quot;</span><span class="p">;</span>
  <span class="kr">discrete</span> <span class="nb">Real</span> <span class="n">y</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">true</span> <span class="s2">&quot;Discrete variable&quot;</span><span class="p">);</span>
  <span class="n">Modelica</span><span class="o">.</span><span class="n">Blocks</span><span class="o">.</span><span class="n">Interfaces</span><span class="o">.</span><span class="n">RealInput</span> <span class="n">u</span> <span class="s2">&quot;Input variable&quot;</span>
    <span class="kr">annotation</span> <span class="p">(</span><span class="n">Placement</span><span class="p">(</span><span class="n">transformation</span><span class="p">(</span><span class="n">extent</span><span class="o">=</span><span class="p">{{</span><span class="o">-</span><span class="mi">140</span><span class="p">,</span><span class="o">-</span><span class="mi">20</span><span class="p">},{</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span><span class="mi">20</span><span class="p">}})));</span>
<span class="kr">equation</span>
  <span class="kr">der</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span>
  <span class="kr">when</span> <span class="p">(</span><span class="n">u</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">)</span> <span class="kr">then</span>
    <span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">;</span>
  <span class="kr">end</span> <span class="kr">when</span><span class="p">;</span>
  <span class="kr">annotation</span> <span class="p">(</span><span class="n">experiment</span><span class="p">(</span><span class="n">StopTime</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">Documentation</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="s2">&quot;</span><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
This model has a state event
when u becomes bigger than x.
<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span><span class="s2">&quot;</span><span class="p">));</span>
<span class="kr">end</span> <span class="nc">StateEvent2</span><span class="p">;</span>
</pre></div>
</div>
<p>This model has one event indicator <span class="math notranslate nohighlight">\(z = u-x\)</span>.
The derivative of the event indicator is <span class="math notranslate nohighlight">\({dz}/{dt} = {du}/{dt} - {dx}/{dt}\)</span>.</p>
<p>Hence, a tool requires the derivative of the input <code class="docutils literal notranslate"><span class="pre">u</span></code>
to compute the derivative of the event indicator.
Since the derivative of the input <code class="docutils literal notranslate"><span class="pre">u</span></code> is unkown in the FMU,
we propose for cases where the event indicator
has a direct feedthrough on the input to exclude
event indicator derivatives from the <code class="docutils literal notranslate"><span class="pre">&lt;EventIndicators&gt;</span></code>
element. In this situation, the QSS solver will detect the missing
information from the XML file and numerically approximate
the event indicator derivatives.</p>
</div>
<div class="section" id="handling-of-variables-reinitialized-with-reinit">
<h5>5.3.1.1.3. Handling of variables reinitialized with <code class="docutils literal notranslate"><span class="pre">reinit()</span></code><a class="headerlink" href="#handling-of-variables-reinitialized-with-reinit" title="Permalink to this headline">¶</a></h5>
<p>Consider following model</p>
<div class="highlight-modelica notranslate"><div class="highlight"><pre><span></span><span class="kr">within</span> <span class="nn">QSS</span><span class="o">.</span><span class="n">Docs</span><span class="p">;</span>
<span class="kr">model</span> <span class="nc">StateEvent3</span> <span class="s2">&quot;This model tests state event detection&quot;</span>
  <span class="kr">extends</span> <span class="n">Modelica</span><span class="o">.</span><span class="n">Icons</span><span class="o">.</span><span class="n">Example</span><span class="p">;</span>
  <span class="nb">Real</span> <span class="n">x1</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">true</span><span class="p">)</span> <span class="s2">&quot;State variable&quot;</span><span class="p">;</span>
  <span class="nb">Real</span> <span class="n">x2</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">true</span><span class="p">)</span> <span class="s2">&quot;State variable&quot;</span><span class="p">;</span>
<span class="kr">equation</span>
  <span class="kr">der</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kr">der</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span> <span class="o">=</span> <span class="n">x1</span><span class="p">;</span>
<span class="kr">when</span> <span class="nb">time</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="kr">then</span>
  <span class="nb">reinit</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="kr">end</span> <span class="kr">when</span><span class="p">;</span>
  <span class="kr">annotation</span> <span class="p">(</span><span class="n">experiment</span><span class="p">(</span><span class="n">StopTime</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">Documentation</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="s2">&quot;</span><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
This model has 1 state event at t=0.5s
when simulated from 0 to 1s.
<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span><span class="s2">&quot;</span><span class="p">));</span>
<span class="kr">end</span> <span class="nc">StateEvent3</span><span class="p">;</span>
</pre></div>
</div>
<p>This model has a variable <code class="docutils literal notranslate"><span class="pre">x1</span></code> which
is reinitialized with the <code class="docutils literal notranslate"><span class="pre">reinit()</span></code> function.
Such variables have in the model description file
an attribute <code class="docutils literal notranslate"><span class="pre">reinit</span></code> which can be set to
<code class="docutils literal notranslate"><span class="pre">true</span></code> or <code class="docutils literal notranslate"><span class="pre">false</span></code> depending on whether they can
be reinitialized at an event or not.
Since  a <code class="docutils literal notranslate"><span class="pre">reinit()</span></code> statement is only valid
in a <code class="docutils literal notranslate"><span class="pre">when-equation</span></code> block, we propose for
variables with <code class="docutils literal notranslate"><span class="pre">reinit</span></code> set to true,
that at every state event, the QSS solver gets the value of
the variable, updates variables which depend on it, and proceeds
with its calculation.</p>
</div>
<div class="section" id="workaround-for-implementing-event-indicators">
<h5>5.3.1.1.4. Workaround for implementing event indicators<a class="headerlink" href="#workaround-for-implementing-event-indicators" title="Permalink to this headline">¶</a></h5>
<p>While waiting for the implementation of the FMI extensions in JModelica,
LBNL will refactor some Modelica models to expose event indicators and
their first derivatives as FMU output variables.</p>
<p>The names of event indicators variables will start with <code class="docutils literal notranslate"><span class="pre">__zc_</span></code>. The names of derivatives of event
indicators will start with <code class="docutils literal notranslate"><span class="pre">__zc_der_</span></code>.  As an example, <code class="docutils literal notranslate"><span class="pre">__zc_z1</span></code> and <code class="docutils literal notranslate"><span class="pre">__zc_der_z1</span></code>
are the names of the event indicator <code class="docutils literal notranslate"><span class="pre">z1</span></code> with its derivative <code class="docutils literal notranslate"><span class="pre">der_z1</span></code>.</p>
<p>If the number of event indicators is equal to the <code class="docutils literal notranslate"><span class="pre">numberOfEventIndicators</span></code> attribute,
then only <code class="docutils literal notranslate"><span class="pre">__zc_</span></code> and <code class="docutils literal notranslate"><span class="pre">__zc_der_</span></code> need to be used by QSS.
If the number of event indicators does not match, the FMU shall be rejected with an error message.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Per design, Dymola (2018) generates twice as many event indicators as actually existing in the model.
Hence the master algorithm shall detect if the tool which exported the FMU is Dymola, and if it is, the
number of event indicators shall be equal to half the value of the <code class="docutils literal notranslate"><span class="pre">numberOfEventIndicators</span></code> attribute.</p>
</div>
</div>
<div class="section" id="time-events">
<h5>5.3.1.1.5. Time Events<a class="headerlink" href="#time-events" title="Permalink to this headline">¶</a></h5>
<p>This section discusses additional requirements for handling time events with QSS.</p>
<p>Consider following model</p>
<div class="highlight-modelica notranslate"><div class="highlight"><pre><span></span><span class="kr">within</span> <span class="nn">QSS</span><span class="o">.</span><span class="n">Docs</span><span class="p">;</span>
<span class="kr">model</span> <span class="nc">TimeEvent</span> <span class="s2">&quot;This model tests time event detection&quot;</span>
  <span class="kr">extends</span> <span class="n">Modelica</span><span class="o">.</span><span class="n">Icons</span><span class="o">.</span><span class="n">Example</span><span class="p">;</span>
  <span class="nb">Real</span> <span class="n">x1</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">true</span><span class="p">)</span> <span class="s2">&quot;State variable&quot;</span><span class="p">;</span>
  <span class="nb">Real</span> <span class="n">x2</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">true</span><span class="p">)</span> <span class="s2">&quot;State variable&quot;</span><span class="p">;</span>
  <span class="kr">discrete</span> <span class="n">Modelica</span><span class="o">.</span><span class="n">Blocks</span><span class="o">.</span><span class="n">Interfaces</span><span class="o">.</span><span class="n">RealOutput</span> <span class="n">y</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">true</span><span class="p">)</span>
    <span class="s2">&quot;Output variable&quot;</span><span class="p">;</span>
<span class="kr">equation</span>
  <span class="kr">der</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kr">der</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">x2</span><span class="p">;</span>
  <span class="kr">when</span> <span class="p">(</span><span class="nb">time</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">)</span> <span class="kr">then</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">x2</span><span class="p">;</span>
  <span class="kr">end</span> <span class="kr">when</span><span class="p">;</span>
  <span class="kr">annotation</span> <span class="p">(</span><span class="n">experiment</span><span class="p">(</span><span class="n">StopTime</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">Documentation</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="s2">&quot;</span><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
This model has 1 time event at t=0.5s
when simulated from 0 to 1s.
<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span><span class="s2">&quot;</span><span class="p">));</span>
<span class="kr">end</span> <span class="nc">TimeEvent</span><span class="p">;</span>
</pre></div>
</div>
<p>This model has a time event at <span class="math notranslate nohighlight">\(t \ge 0.5\)</span>.
For efficiency, QSS requires the FMU which exports
this model to indicate in its model description file
the dependency of <code class="docutils literal notranslate"><span class="pre">der(x1)</span></code> on <code class="docutils literal notranslate"><span class="pre">y</span></code>.
However, since <code class="docutils literal notranslate"><span class="pre">y</span></code> updates when a time event happens
but a time event is not described with event indicator,
it is not possible to use the same approach as done for
<code class="docutils literal notranslate"><span class="pre">StateEvent1</span></code> without further modificaton.</p>
<p>We therefore propose that JModelica turns all time events into state events,
add new event indicators generated by those state events to the <code class="docutils literal notranslate"><span class="pre">&lt;EventIndicators&gt;</span></code>
element, and include those event indicators to the <code class="docutils literal notranslate"><span class="pre">eventIndicatorsDependencies</span></code> attribute
of state derivatives which depend on them.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">All proposed XML changes will be initially implemented
in the <code class="docutils literal notranslate"><span class="pre">VendorAnnotation</span></code> element of the model description file until
they got approved and included in the FMI standard.</p>
</div>
</div>
</div>
<div class="section" id="smoothtoken-for-qss">
<h4>5.3.1.2. SmoothToken for QSS<a class="headerlink" href="#smoothtoken-for-qss" title="Permalink to this headline">¶</a></h4>
<p>This section discusses a proposal for a new data type which should be used for input and output variables of FMU-QSS.
FMU-QSS is an FMU for Model Exchange (FMU-ME) which uses QSS to integrate an imported FMU-ME.
We propose that FMU-QSS communicates with other FMUs using a SmoothToken data type.</p>
<p>A smooth token is a time-stamped event that has a real value (approximated as a <code class="docutils literal notranslate"><span class="pre">double</span></code>)
that represents the current sample of a real-valued smooth signal. But in addition to the sample value,
the smooth token contains zero or more time-derivatives of the signal at the stored time stamp.
For example, in the figure below, FMU-ME has a real input <span class="math notranslate nohighlight">\(u\)</span> and a real output <span class="math notranslate nohighlight">\(y\)</span>.
A smooth token of the input variable will be a variable <span class="math notranslate nohighlight">\(u^* \triangleq [u, n, du/dt, ...,  d^n u/dt^n, t_u]\)</span>,
where <span class="math notranslate nohighlight">\(n \in \{0, 1, 2, \ldots \}\)</span> is a parameter that defines the number of time derivatives that are present in the smooth token and
<span class="math notranslate nohighlight">\(t_u\)</span> is the timestamp of the smooth token.
If <span class="math notranslate nohighlight">\(u^*\)</span> has a discontinuity at <span class="math notranslate nohighlight">\(t_u\)</span>,
then the derivatives are the derivatives from above, e.g., <span class="math notranslate nohighlight">\(du/dt \triangleq \lim_{s \downarrow 0} (u(t_u+s)-u(t_u))/s\)</span>.</p>
<p>At simulation time <span class="math notranslate nohighlight">\(t\)</span>, FMU-QSS will receive <span class="math notranslate nohighlight">\(u^*\)</span> and convert it to a real signal
using the Taylor expansion</p>
<div class="math notranslate nohighlight">
\[y_s(t) = \frac{u^{(n)}(t_u)}{n!} \, (t-t_u)^n,\]</div>
<p>where <span class="math notranslate nohighlight">\(u^{(n)}\)</span> denotes the <span class="math notranslate nohighlight">\(n\)</span>-th derivative. As shown in <a class="reference internal" href="#fig-fmu-qss"><span class="std std-numref">Fig. 5.4</span></a>, the FMU-ME will receive
the value <span class="math notranslate nohighlight">\(y_s(t)\)</span>.</p>
<div class="figure" id="id18">
<span id="fig-fmu-qss"></span><a class="reference internal image-reference" href="_images/fmu-qss.png"><img alt="_images/fmu-qss.png" src="_images/fmu-qss.png" style="width: 1069.2px; height: 392.15px;" /></a>
<p class="caption"><span class="caption-number">Fig. 5.4 </span>: Conversion of input signal between FMU-QSS and FMU-ME.</span></p>
</div>
<p>To avoid frequent changes in the input signal, each input signal will have a quantum defined.
The quantum <span class="math notranslate nohighlight">\(\delta q\)</span> will be computed at runtime as</p>
<div class="math notranslate nohighlight">
\[\delta q = \max(\epsilon_{rel} \, |u^-|, \epsilon_{abs}),\]</div>
<p>where <span class="math notranslate nohighlight">\(\epsilon_{rel}\)</span> is the relative tolerance,
<span class="math notranslate nohighlight">\(u^-\)</span> is the last value seen at the input of FMU-ME, and
<span class="math notranslate nohighlight">\(\epsilon_{abs} \triangleq \epsilon_{rel} \, |u_{nom}|\)</span>,
where <span class="math notranslate nohighlight">\(u_{nom}\)</span> is the nominal value of the variable <span class="math notranslate nohighlight">\(u\)</span>.
During initialization, we set <span class="math notranslate nohighlight">\(u^- = u_0\)</span>.
The input signal will be updated only if it has changed by more than a quantum,</p>
<div class="math notranslate nohighlight">
\[|y_s(t) - u^-| \ge \delta q.\]</div>
<p>To parametrize the smooth token, we propose to extend the FMI for model exchange specification to include
<code class="docutils literal notranslate"><span class="pre">fmi2SetRealInputDerivatives</span></code> and <code class="docutils literal notranslate"><span class="pre">fmi2GetRealOutputDerivatives</span></code>. These two functions exist in the FMI for
co-simulation API.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ul class="last">
<li><p class="first">If a tool can not provide the derivative of an output variable with respect to time,
<code class="docutils literal notranslate"><span class="pre">fmi2GetRealOutputDerivatives</span></code> then a master algorithm could approximate
the output derivative as follows:</p>
<ul>
<li><p class="first">If there was no event, then the time derivatives from below and above are equal, and
hence past and current output values can be used, e.g.,</p>
<div class="math notranslate nohighlight">
\[dy/dt \approx \frac{y(t_k)-y(t_{k-1})}{t_k - t_{k-1}}.\]</div>
</li>
<li><p class="first">If there was an event, then the derivative from above need to be approximated.
This could be done by assuming first <span class="math notranslate nohighlight">\(dy/dt =0\)</span> and then building up derivative
information in the next step, or by evaluating the FMU for <span class="math notranslate nohighlight">\(t=t_k+\epsilon\)</span>, where
<span class="math notranslate nohighlight">\(\epsilon\)</span> is a small number, and then computing</p>
<div class="math notranslate nohighlight">
\[dy/dt \approx \frac{y(t_k+\epsilon)-y(t_{k})}{\epsilon}.\]</div>
</li>
</ul>
</li>
<li><p class="first">For FMU-ME, if there is a direct feedthrough, e.g., <span class="math notranslate nohighlight">\(y=f(u)\)</span>,
then <span class="math notranslate nohighlight">\(dy/dt\)</span> cannot be computed, because by the chain rule,</p>
<div class="math notranslate nohighlight">
\[\frac{df(u)}{dt} = \frac{df(u)}{du} \, \frac{du}{dt}\]</div>
<p>but <span class="math notranslate nohighlight">\(du/dt\)</span> is not available in the FMU.</p>
</li>
</ul>
</div>
</div>
<div class="section" id="summary-of-proposed-changes">
<h4>5.3.1.3. Summary of Proposed Changes<a class="headerlink" href="#summary-of-proposed-changes" title="Permalink to this headline">¶</a></h4>
<p>Here is a list with a summary of proposed changes</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">fmi2SetReal</span></code> can be called during the continuous, and event time mode for continuous-time states.</li>
<li>The <code class="docutils literal notranslate"><span class="pre">&lt;Derivatives&gt;</span></code> element of the model description file will
be extended to include higher order derivatives information.</li>
<li>A new <code class="docutils literal notranslate"><span class="pre">&lt;EventIndicators&gt;</span></code> element wil be added to the model description file.
This element will expose event indicators with their <code class="docutils literal notranslate"><span class="pre">dependencies</span></code> and time derivatives.</li>
<li>If a model has an event indicator, and the event indicator has a direct
feedthrough on an input variable, then JModelica will exclude the derivatives
of that event indicator from the model description file.</li>
<li>A new dependency attribute <code class="docutils literal notranslate"><span class="pre">eventIndicatorsDependencies</span></code> will be added to state derivatives listed
in the <code class="docutils literal notranslate"><span class="pre">&lt;Derivatives&gt;</span></code> element to include event indicators on which the state derivatives depend on.</li>
<li>JModelica will convert time event into state events, generate event indicators
for those state events, and add those event indicators to the <code class="docutils literal notranslate"><span class="pre">eventIndicatorsDependencies</span></code>
of state derivatives which depend on them.</li>
<li>A new function <code class="docutils literal notranslate"><span class="pre">fmi2SetRealInputDerivatives</span></code> will be included to parametrize smooth token.</li>
<li>A new function <code class="docutils literal notranslate"><span class="pre">fmi2GetRealOutputDerivatives</span></code> will be included to parametrize smooth token.</li>
<li>All proposed XML changes will be initially implemented in the <code class="docutils literal notranslate"><span class="pre">VendorAnnotation</span></code>
element of the model description file until they got approved and included in the FMI standard.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ul class="last simple">
<li>We need to determine when to efficiently call <code class="docutils literal notranslate"><span class="pre">fmi2CompletedIntegratorStep()</span></code> to signalize that
an integrator step is complete.</li>
<li>We need to determine how an FMU deals with state selection, detect it, and reject it
on the QSS side.</li>
</ul>
</div>
</div>
<div class="section" id="open-topics">
<h4>5.3.1.4. Open Topics<a class="headerlink" href="#open-topics" title="Permalink to this headline">¶</a></h4>
<p>This section includes a list of measures which could further improve the efficiency of QSS.
Some of the measures should be implemented and benchmarked to ensure their necessity for QSS.</p>
<div class="section" id="atomic-api">
<h5>5.3.1.4.1. Atomic API<a class="headerlink" href="#atomic-api" title="Permalink to this headline">¶</a></h5>
<p>A fundamental property of QSS is that variables are advanced at different time rates.
To make this practically efficient with FMUs, an API for individual values and derivatives is essential.</p>
</div>
<div class="section" id="xml-api">
<h5>5.3.1.4.2. XML/API<a class="headerlink" href="#xml-api" title="Permalink to this headline">¶</a></h5>
<p>All variables with non-constant values probably need to be exposed via the xml
with all their interdependencies. The practicality and benefit of trying
to hide some variables such as algebraic variables by short-circuiting
their dependencies in the xml (or doing this short-circuiting on the QSS side)
should be considered for efficiency reasons.</p>
</div>
<div class="section" id="higher-derivatives">
<h5>5.3.1.4.3. Higher Derivatives<a class="headerlink" href="#higher-derivatives" title="Permalink to this headline">¶</a></h5>
<p>Numerical differentiation significantly complicates and slows the QSS code:
automatic differentiation provided by the FMU will be a major improvement
and allows practical development of 3rd order QSS solvers.</p>
</div>
<div class="section" id="input-variables">
<h5>5.3.1.4.4. Input Variables<a class="headerlink" href="#input-variables" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Input functions with discontinuities up to the QSS order need to be exposed to
QSS and provide next event time access to the master algorithm.</li>
<li>Input functions need to be true (non-path-dependent) functions for
QSS use or at least provide a way to evaluate without “memory”
to allow numeric differentiation and event trigger stepping.</li>
</ul>
</div>
<div class="section" id="annotations">
<h5>5.3.1.4.5. Annotations<a class="headerlink" href="#annotations" title="Permalink to this headline">¶</a></h5>
<p>Some per-variable annotations that will allow for more efficient solutions by overriding global settings (which are also needed as annotations) include:</p>
<ul class="simple">
<li>Various time steps: <code class="docutils literal notranslate"><span class="pre">dt_min</span></code>, <code class="docutils literal notranslate"><span class="pre">dt_max</span></code>, <code class="docutils literal notranslate"><span class="pre">dt_inf</span></code>, …</li>
<li>Various flags: QSS method/order (or traditional ODE method for mixed solutions), inflection point requantization, …</li>
<li>Extra variability flags: constant, linear, quadratic, cubic, variable, …</li>
</ul>
</div>
<div class="section" id="conditional-expressions-and-event-indicators">
<h5>5.3.1.4.6. Conditional Expressions and Event Indicators<a class="headerlink" href="#conditional-expressions-and-event-indicators" title="Permalink to this headline">¶</a></h5>
<ul>
<li><p class="first">How to reliably get the FMU to detect an event at the time QSS predicts one?</p>
<p>QSS predicts zero-crossing event times that, even with Newton refinement,
may be slightly off. To get the FMU to “detect” these events with its
“after the fact” event indicators the QSS currently bumps the time forward
by some epsilon past the predicted event time in the hopes that the FMU will detect it.
Even if made smarter about how big a step to take this will never be robust.
Missing events can invalidate simulations. If there is no good and efficient FMU API
solution we may need to add the capability for the QSS to handle “after the fact” detected
events but with the potential for large QSS time steps and without rollback
capability this would give degraded results at best.</p>
</li>
<li><p class="first">How much conditional structure should we expose to QSS?</p>
<p>Without full conditional structure information the QSS must fire events
that aren’t relevant in the model/FMU. This will be inefficient
for models with many/complex conditionals. These non-event events also
alter the QSS trajectories so, for example, adding a conditional
clause that never actually fires will change the solution somewhat, which is non-ideal.</p>
</li>
<li><p class="first">QSS needs a mechanism similar to zero crossing functions to deal with Modelica’s event generating functions (such as
<code class="docutils literal notranslate"><span class="pre">div(x,y)</span></code> See <a class="reference external" href="http://book.xogeny.com/behavior/discrete/events/#event-generating-functions">http://book.xogeny.com/behavior/discrete/events/#event-generating-functions</a>) to avoid missing solution discontinuities.</p>
</li>
<li><p class="first">Discrete and non-smooth internal variables need to be converted to input variables or exposed (with dependencies) to QSS.</p>
</li>
<li><p class="first">QSS need dependency information for algebraic and boolean/discrete variables
either explicitly or short-circuited through the exposed variables for those the QSS won’t track.</p>
</li>
<li><p class="first">The xml needs to expose the structure of each conditional block:
if or when, sequence order of if/when/else conditionals,
and all the (continuous and discrete/boolean) variables appearing in each conditional.</p>
</li>
<li><p class="first">Non-input boolean/discrete/integer variables should ideally be altered
only by event indicator handlers or <em>time events</em> that are exposed by the FMU
(during loop or by direct query?). Are there other ways that
such variables can change that are only detectable after the fact?
If so, this leaves the QSS with the bad choices of late detection
(due to large time steps) or forcing regular time step value checks on them.</p>
</li>
<li><p class="first">QSS needs the dependencies of conditional expressions on variables appearing in them.</p>
</li>
<li><p class="first">QSS needs the dependencies of variables altered when each conditional fires on the conditional expression variables.</p>
</li>
<li><p class="first">It is not robust for the QSS to try and guess a time point where the FMU will
reliably detect a zero crossing so we need an API to tell the
FMU that a zero crossing occurred at a given time (and maybe with crossing direction information).</p>
</li>
<li><p class="first">If the xml can expose the zero crossing directions of interest that will allow for more efficiency.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="section" id="openstudio-integration">
<h2>5.4. OpenStudio integration<a class="headerlink" href="#openstudio-integration" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This section needs to be revised in view of the move towards a json-driven architecture.</p>
</div>
<div class="section" id="automated-documentation-ast-support-tool">
<h3>5.4.1. Automated Documentation/AST Support Tool<a class="headerlink" href="#automated-documentation-ast-support-tool" title="Permalink to this headline">¶</a></h3>
<p>This section describes how to
generate automated SOEP documentation and abstract syntax trees from
the Modelica Buildings Library (MBL), or from other Modelica libraries that
users may use with SOEP.
The goal is to expose the <a class="reference external" href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">abstract
syntax tree (AST)</a> of the
MBL, and make it available to other tools via one or several json files.
These json files can then be used by OpenStudio to
discover available models and their parameters and other metadata for use
from the OpenStudio interface for SOEP.</p>
<div class="section" id="background">
<h4>5.4.1.1. Background<a class="headerlink" href="#background" title="Permalink to this headline">¶</a></h4>
<p>Modelica source code contains a lot of meta-data in addition to the
mathematical model itself. An annotation system exists within Modelica and
custom annotations can be written to pass data to tools. Annotations were
designed to be an extensible mechanism for capturing meta-data related to a
model including html-documentation, vendor-specific data, and graphical
annotations. Parameters, variables, equations, and models can contain
documentation strings and annotations. Furthermore, packages can be documented
and the display order of sub-packages, models, classes, functions, connectors
and other objects can be specified. Modelica libraries have a hierarchical
structure consisting mainly of packages which contain models and other objects
as well as sub-packages. Models themselves can be composed of multiple, possibly
replaceable, components. Much of this information will be required by the
OpenStudio tool in order to understand which component models are available,
where they reside in the library’s package structure which determines their fully
qualified name, what parameters they have, how they can be configured, how to
display them, and what other meta-data are available, such as documentation
strings and type of connectors that can be connected with each other.</p>
<p>This section is concerned about making the AST of Modelica source files,
including the metadata mentioned above, available to OpenStudio. We
will specifically focus on the Modelica Buildings Library (MBL), but other
Modelica libraries can be used as well.</p>
<p>The intent of the AST representation is <em>primarily</em> to be consumed by the
OpenStudio application for identification of models, model documentation, model
connecting points, inputs/outputs, and parameters and related meta-data.</p>
<p>An OpenStudio application will consume some or all of the above
information, use it to provide an interface to the user, and ultimately write
out a Modelica file which connects the various library components, configures
various components, and assigns values to parameters.</p>
<p>To create models, information from other libraries, most notably, the Modelica
Standard Library (MSL), may need to be made available. Typical
applications and examples from the MBL use
component models from both the MSL and MBL. There is also interest in being
able to support additional third party libraries.</p>
</div>
<div class="section" id="requirements">
<h4>5.4.1.2. Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h4>
<p>This section will describe the requirements of a batch-process program
that will transform any
Modelica input file or library into a json file. The json file shall contain:</p>
<ul class="simple">
<li>identification of which models, classes, connectors, functions, etc. exist</li>
<li>identification of the relative hierarchy of the above components within the
package structure of the library</li>
<li>for each package,<ul>
<li>what models are available</li>
<li>what connection “ports” are available</li>
<li>for fluid ports, which ports carry the same fluid
(so that media assignments can be propagated through a circuit) <a class="footnote-reference" href="#fn-flu" id="id1">[1]</a></li>
<li>what control inputs/outputs are available</li>
<li>what parameters are available</li>
<li>what configuration management options exist (i.e., replaceable components
and packages and which parameters belong to which component)</li>
<li>meta-data and attributes for all the above such as graphics
annotations, vendor annotations, html documentation, etc.</li>
</ul>
</li>
</ul>
<p>For integration with OpenStudio, the tool should reduce dependencies
that complicate the distribution to users.</p>
<p>The tool shall also have options to exclude certain packages. For example,
OpenStudio may give access to the package <cite>Modelica.Blocks</cite>
but not to <cite>Modelica.Magnetic</cite>.</p>
<p>The tool shall also allow to perform a “diff” (i.e., logical
differences) between two generated json files.
The purpose of the diff tool would be to detect non-trivial
differences between two generated json files that hold the AST of a Modelica
library and report those changes. The content of the
“difference” file would show the differences between the two
input manifests.</p>
<p>The diff tool would be of use in particular when new versions of the
MBL are released and the OpenStudio team would like to check if there are
non-trivial changes they need to integrate.</p>
<p>The following two lists attempt to list examples of changes that
cannot be ignored as well as changes that can be ignored.</p>
<p><em>Significant Changes (backward-incompatible)</em></p>
<ul class="simple">
<li>changes to names of any public package, model, block, function, record, as well
as public constants, parameters, variables, connectors, or subcomponents</li>
<li>addition of any public parameters that has no default value,
variables that have no equation (in a partial model), connectors (except for output connectors),
or subcomponents that require changes to models that extend or instantiate these components</li>
<li>addition/subtraction of packages/models/blocks/functions meant to be consumed
by OpenStudio</li>
<li>removing of any public constant, parameter, or class (model, block, function, type etc.)</li>
<li>moving a class between packages (i.e., changing the path)</li>
</ul>
<p><em>Changes that may be ignored (backward-compatible)</em></p>
<ul class="simple">
<li>changes in style without changes in meaning (addition or removal of
whitespace, reordering within a section)</li>
<li>changes to documentation strings</li>
<li>changes to text in embedded HTML documentation</li>
<li>changes to revision notes</li>
<li>changes to graphical annotations</li>
<li>changes in ordering of models/blocks/functions within a package</li>
<li>changes to <cite>protected</cite> sections of code</li>
<li>changes to <cite>equation</cite> or <cite>algorithm</cite> sections of code</li>
<li>changes to some models/blocks/functions may be completely ignored if, by
convention, we deem certain paths as “not directly consumable” by OpenStudio.
For example, we may wish to not consume classes in the packages <cite>BaseClasses</cite>,
<cite>Examples</cite> and <cite>Validations</cite>.</li>
</ul>
<p>To summarize, the creation of or changes to the “public API” (public
parameters, variables, subcomponents, connectors) of models, blocks, or
functions must be compared for change detection. Documentation (html)/
documentation strings/graphics annotations will not affect the model interface
or semantics. Changes to protected properties or equations will not affect
the interface (but may affect the actual numeric output quantities).</p>
</div>
<div class="section" id="literature-review">
<h4>5.4.1.3. Literature review<a class="headerlink" href="#literature-review" title="Permalink to this headline">¶</a></h4>
<p>There have been several attempts to represent or use XML in relation to
Modelica in the past (<a class="reference internal" href="zreferences.html#landin2014" id="id2">[Lan14]</a>, <a class="reference internal" href="zreferences.html#fritzson2003g" id="id3">[Fri03]</a>,
<a class="reference internal" href="zreferences.html#pop2003" id="id4">[PF03]</a>, <a class="reference internal" href="zreferences.html#pop2005" id="id5">[PSAssmannF05]</a>, and <a class="reference internal" href="zreferences.html#reisenbichler2006" id="id6">[RKH+06]</a>).</p>
<p>In particular, Landin <a class="reference internal" href="zreferences.html#landin2014" id="id7">[Lan14]</a> did work with Modelon using JModelica to export XML for
the purpose of model exchange, which is similar to our use case.
Unfortunately, this work deals only with “flattened” models – Modelica models
that have been instantiated with all of the hierarchy removed. For our use
case, the hierarchy must be preserved so that the OpenStudio team can
build a new model through instantiation of models from the MBL.
For this purpose, JModelica also provides access to the the source AST and instance AST
(see the <a class="reference external" href="http://www.jmodelica.org/api-docs/usersguide/JModelicaUsersGuide-1.17.0.pdf">JModelica user guide</a>).</p>
<p>Reisenbichler <a class="reference internal" href="zreferences.html#reisenbichler2006" id="id8">[RKH+06]</a> motivates the usage of XML in association with
Modelica without getting into specifics.
The remaining work by Pop and Fritzson
is thus the only comprehensive work on an XML representation of Modelica
<em>source</em> AST that appears in the literature
(<a class="reference internal" href="zreferences.html#pop2003" id="id9">[PF03]</a>, <a class="reference internal" href="zreferences.html#pop2005" id="id10">[PSAssmannF05]</a>, and <a class="reference internal" href="zreferences.html#fritzson2003g" id="id11">[Fri03]</a>).
The purpose of the XML work by Pop
and Fritzson was to create a complete XML representation of the entire Modelica
source.</p>
<p>ANTLR (ANother Tool for Language Recognition)
is a parser generator for reading, processing, executing, or
translating structured text or binary files.
It is widely used to build languages, tools, and frameworks.
From a grammar, ANTLR generates a parser that can build parse trees and
also generates a listener interface (or visitor) that makes it easy
to respond to the recognition of phrases of interest.
For ANTLR, a Modelica grammar is available at
<a class="reference external" href="https://github.com/antlr/grammars-v4/blob/master/modelica/modelica.g4">https://github.com/antlr/grammars-v4/blob/master/modelica/modelica.g4</a>.</p>
</div>
<div class="section" id="implementation">
<h4>5.4.1.4. Implementation<a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h4>
<p>Work started on the implementation of a modelica-json translator.
The development page is <a class="reference external" href="https://github.com/lbl-srg/modelica-json">https://github.com/lbl-srg/modelica-json</a></p>
<p>To illustrate the translation, consider the following simple model:</p>
<div class="highlight-modelica notranslate"><div class="highlight"><pre><span></span><span class="kr">within</span> <span class="nn">FromModelica</span><span class="p">;</span>
<span class="kr">block</span> <span class="nc">BlockWithBlock1</span> <span class="s2">&quot;A block that instantiates another public and protected block&quot;</span>
  <span class="n">Block1</span> <span class="n">bloPub</span> <span class="s2">&quot;A public block&quot;</span><span class="p">;</span>
<span class="kr">protected</span>
  <span class="n">Block1</span> <span class="n">bloPro</span> <span class="s2">&quot;A protected block&quot;</span><span class="p">;</span>
<span class="kr">end</span> <span class="nc">BlockWithBlock1</span><span class="p">;</span>
</pre></div>
</div>
<p>When parsed to json, the output is:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="p">[</span>
  <span class="p">{</span>
    <span class="s2">&quot;modelicaFile&quot;</span><span class="o">:</span> <span class="s2">&quot;./BlockWithBlock1.mo&quot;</span><span class="p">,</span>
    <span class="s2">&quot;within&quot;</span><span class="o">:</span> <span class="s2">&quot;FromModelica&quot;</span><span class="p">,</span>
    <span class="s2">&quot;topClassName&quot;</span><span class="o">:</span> <span class="s2">&quot;FromModelica.BlockWithBlock1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;comment&quot;</span><span class="o">:</span> <span class="s2">&quot;A block that instantiates another public and protected block&quot;</span><span class="p">,</span>
    <span class="s2">&quot;public&quot;</span><span class="o">:</span> <span class="p">{</span>
      <span class="s2">&quot;models&quot;</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;className&quot;</span><span class="o">:</span> <span class="s2">&quot;Block1&quot;</span><span class="p">,</span>
          <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;bloPub&quot;</span><span class="p">,</span>
          <span class="s2">&quot;comment&quot;</span><span class="o">:</span> <span class="s2">&quot;A public block&quot;</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">},</span>
    <span class="s2">&quot;protected&quot;</span><span class="o">:</span> <span class="p">{</span>
      <span class="s2">&quot;models&quot;</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;className&quot;</span><span class="o">:</span> <span class="s2">&quot;Block1&quot;</span><span class="p">,</span>
          <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;bloPro&quot;</span><span class="p">,</span>
          <span class="s2">&quot;comment&quot;</span><span class="o">:</span> <span class="s2">&quot;A protected block&quot;</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
<p class="rubric">Footnotes</p>
<table class="docutils footnote" frame="void" id="fn-flu" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>We anticipate that the MBL will be redesigned so that users no longer
need to assign media.</td></tr>
</tbody>
</table>
</div>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
  
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
      
    </p>
    <p>
        &copy; Copyright (c) All rights reserved.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.2.<br/>
    </p>
  </div>
</footer>

  </body>
</html>